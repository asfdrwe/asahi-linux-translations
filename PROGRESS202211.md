[Updates galore! November 2022 Progress Report](https://asahilinux.org/2022/11/november-2022-report/)の非公式日本語訳です。

訳注
- ブログへのリンクやwikiへのリンクを対応する日本語訳ページへのリンクに置き換え

---
# アップデート満載！ 進捗報告:2022年11月

- [前回](https://github.com/asfdrwe/asahi-linux-translations/blob/main/PROGRESS202207.md)

またまた遅ればせながら進捗報告の時間がやってまいりました。今月のアップデートでは、新しいハードウェアの対応や新機能や
長年の問題点の修正に加え、待望のサスペンドとディスプレイコントローラに対応した最先端カーネルブランチが詰め込まれています！

Asahi Linuxに初めて触れる方は、[以前のリリース告知](https://github.com/asfdrwe/asahi-linux-translations/blob/main/PROGRESS202203.md)にある
インストール方法と一般的な情報をご覧ください。

## USB3 第1章

これまで、Asahi Linuxは、ThunderboltポートのUSB2のみ対応していました。ハードウェアのUSB2/3コントローラは既にLinuxでそこそこ対応しており、
Type-Cポートのコントローラも既存の一部対応しているハードウェアをベースにしていますが、大きな欠落部分がありました。PHYドライバです。

M1以降のApple Silicon機器は、USB3、DisplayPort、TB3/USB4モードに対応する『Apple Type-C PHY』（ATCPHY）というAppleが設計した
（あるいはAppleがカスタマイズした？）PHYハードウェアを使用しています。このハードウェアはUSB3/DP/TBプロトコルのデータを配線上の
信号にする役割を担っています。非常に高速な信号（ペアあたり最大20Gbps）を扱うため、PHYは非常に複雑で、個別に校正する必要のある
アナログつまみがたくさんあります。USB2 ではどのデバイスでも動作する普遍的な設定で済みますが、USB3やより高速なプロトコルではそうはいきません！

PHY ドライバの仕事は、工場で校正された特定のチップに特有の設定で物理的ハードウェアを構成することであり、異なるモードが切り替わったときに 
PHY ハードウェア全体の再構成を管理することです。実際には、これは、工場で書かれた電子ヒューズ から来る可変データを含む、膨大な数の
『マジック』レジスタへの
書き込みを意味します。[Sven氏](https://social.treehouse.systems/@sven) は、これら全てのリバースエンジニアリングに取り組み、この新しい
リリースには、USB3 モードに対応する新しい ATCPHY ドライバが含まれています！

PHY 自体の駆動に加えて、PHY ドライバは、USB コントローラドライバ (``dwc3``) とタイプ C ポートコントローラドライバ (``tipd``) とを
大変慎重に調整しなければなりません。デバイスが接続されたり外されたりするとき、複雑なネゴシエーションのダンスが起こり、最終的に、
どのワイヤ上でどのプロトコルを実行するかを決定することにつながります。この情報はPHY が適切に信号をルーティングできるよう
PHY に伝えられなければならず(ケーブルをどのような向きで差し込んだかなども含む）、全てが正しい順序で初期化された後に、
USB コントローラが起動されます。さらに厄介なことに、このハードウェアは非常に気まぐれで、何か問題が起きるとコントローラがロックしたり動作
しなくなったりする可能性があります！

USB3モードはかなり堅固だと思いますが、デバイスを素早くホットプラグするようなことをするときには、いくつかの不具合が予想されます。
ただし、ケーブルのホットプラグによるモード切り替えは、ほぼすべてをリセットすることになるので、一時的な問題であれば、デバイスの接続を
解除して再接続すれば解決することが多いでしょう。実際のUSB3の動作は一度接続すれば問題ないはずですが、何か問題が発生した場合はご連絡ください。

## USB3 第2x7章 Gen3.1415
これでThunderbolt/USB4ポートが網羅されましたが、USBにはもうちょっと欠けてることがあります。Mac StudioとiMacのType-Aと
非Thunderbolt Type-Cのポートです！これら追加ポート（ハードウェアのモデルによって組み合わせは異なる）はASMedia PCIe USB3
コントローラによって処理されます。これは単なる標準的な USB PCIe xHCI コントローラで、Linux の標準ドライバですでに十分対応
していますが、話にAppleでのひねりが存在します。Apple Silicon プラットフォームでは、コントローラはドライバによってアップ
ロードされるファームウェアが必要です！

通常、この種のハードウェアは、コントローラを実行するためのファームウェアを含むフラッシュメモリと共に出荷されるはずです。
しかし、AppleはランダムなFlashメモリをあまり好みません。それには理由があり、Flashメモリは不正アクセスや
破損する可能性があり、検証やセキュアブートの実装が困難になるからです。このためApple のエンジニアは、これらの
プラットフォームのファームウェア Flash メモリの数を着実に減らしてきており、今回は、単にFlashメモリなしで出荷し、
起動時にカーネルがファームウェアをアップロードするようにしたのです。

これは単純な問題に見えるかもしれませんし、実際にファームウェアのアップロードはほとんどそうです（これを行うために
必要な文書化されていないレジスタのダンスは、理解して確実に動作させるのがそれほど簡単ではありませんでしたが...）。
ですが、結局、Asahi Linux でファームウェアを扱う方法を完全に考え直さなければなりませんでしたし、
インストーラに変更を加えて新しいソフトウェアパッケージとベンダーバイナリを出荷しなければなりませんでした。

結局のところ、ASMediaのファームウェアはmacOSのXNUカーネルバイナリに組み込まれているため、Linuxで利用できるように
するためにファームウェアを抽出する必要があります。この問題が起こるとわかっていたので、将来インストーラで使用するために、
そのカーネルのコピーを/boot/efi/asahi/に隠しておきました。しかし、このカーネルは img4 フォーマットであり
Apple が開発した lzfse アルゴリズムで圧縮されているため、最終的には、既存の Asahi ユーザがシームレスにアップグレードし、
ファームウェアが自動的に抽出されるように、これを新しいパッケージとして提供しなければならなくなりました。

一方、Asahi Linux Installer内のmacOS上で、新規インストール時に同じ処理を行う必要があります。macOSには
もちろんlzfseをサポートする独自の圧縮フレームワークが同梱されており、``ctypes``を使ってPythonから直接使うことができますが、
もうひとつ問題が生じました！これはmacOSでは動作しますが、recoveryOSにはPythonが``ctypes``を動作させるために必要な
``libffi``が同梱されていないことがわかりました。そのため、macOS と recoveryOS のどちらからインストーラを実行しても
シームレスに動作するように、（Homebrew パッケージの）``libffi`` のコピーをインストーラと一緒に供給しなければ
ならなくなったのです。

それでは不十分で、このファームウェアは、Asahi のベンダー・ファームウェアの仕組みを完全に再設計することになりました。
これまで、initramfs が働き始めた後は、起動した OS からファームウェアをロードすることだけ で済ませていました。
これはWiFiやBluetoothのファームウェアについては十分に機能しますが、人々は通常、キーボードがinitramfsの中で
動作することを期待しており、そのキーボードはASMedia xHCIポートの1つに接続されている可能性があります。
その上、最初に設計したベンダーファームウェアをインストールする仕組みは無茶がありました。というのは、
WiFi/BTハードウェアが初回起動時にファームウェアの準備ができる前にカーネルによって検出される可能性があるからです
（特にM2機でインストール後の最初の起動時にWiFiが壊れることがあるのはこのせいです）。大きな変化の時期でした。

新しい仕組みは、更新済み
[Apple Silicon MacでのオープンOSエコシステム](https://github.com/asfdrwe/asahi-linux-translations/wiki/Apple-Silicon-Mac%E3%81%A7%E3%81%AE%E3%82%AA%E3%83%BC%E3%83%97%E3%83%B3OS%E3%82%A8%E3%82%B3%E3%82%B7%E3%82%B9%E3%83%86%E3%83%A0)
ページに記載されていますが、その要点は以下の通りです。ファームウェアパッケージのフォーマットを tarball から ``cpio`` 
アーカイブに変更し、initramfs で何よりも先に tmpfs にロードし、最終的にルートファイルシステム上の tmpfs マウントを
使ってそれを保持するようにしました。これはまた、パッチでカーネルに新しいファームウェアのロードパスを追加することも含んでいます。
最終的には、はるかに堅牢で法的にもより安全なシステムになりました。というのは、initramfsがudevが起動する前(つまり
ファームウェアを必要とするドライバがロードされる前)にファームウェアがロードされることを保証することができ、ルートファイル
システム内に永続することも、ディストリビューションによって提供されるファームウェア(例えば、linux-firmware)と混ざる
こともないからです。さらに、アーカイブが``cpio`` であるため、ブートローダがブート時にアドオン initramfs として
ロードすることができ、組み込みドライバと一緒に動作することができ、起こりえるすべての競合状態を完全に排除することができます。
Asahi Linux では、現在、デフォルトではこれを行いませんが、``/boot`` を再構成して EFI システムパーティションを直接
マウントし、そこにカーネルとブートローダをインストールすることが、対応可能な構成になります（将来、これを行うための手順を
提供します。現時点では自己責任ですが、 ``asahi-scripts`` パッケージは両方のレイアウトにシームレスに対応するでしょう）。
``cpio`` がブートローダによってロードされていない場合、[initramfs スクリプト](https://github.com/AsahiLinux/asahi-scripts/blob/main/initcpio/hooks/asahi)が探してロードしてくれるので、どちらの構成も同じような結果になります。

ふぅー! ASMediaのファームウェアをロードするのは、かなりの冒険でしたね！しかし、これですべての機器で
ファーストブートWiFiが強固になり、今後のファームウェア管理設計に自信を持つことができました。

## オーディオの進歩 トラック♪
スピーカーはどうなりましたか、という声が聞こえてきそうです。その通りです！ここ数カ月、スピーカードライバーは動作していたのですが、
正当な理由で有効にしていなかったのです。というのも、もっと複雑な音量制限や安全システムがないと、スピーカーを破壊して
しまうのではないかという強い疑念があったのです。結果的には...その疑いは正しかったのです！チームのために、MacBook Air M2で
いくつかのテストを行うことにしましたが、常識的な音量制限を設けても、すぐにツイーター(訳注:高音域用スピーカー)をぶっ壊すことに
成功しました。おっと！まだスピーカーを有効にしていなくてよかったです！

この実験をきっかけに、スピーカーを安全に駆動するために何が必要なのかを詳しく調べてみたところ、その答えは予想以上に複雑でした。
最新のマイクロスピーカーは、良い音を出すために高度なソフトウェアEQ(訳注: equalizer、イコライザー)が必要ですが、
同時に高度な安全モデルも必要なのです！
マイクロスピーカーにとって最も重要な安全パラメータは、ボイスコイルの温度です。溶かしてはいけません。しかし、
スピーカーがどの程度熱くなるかは、スピーカーにどれだけの電力が供給されているかに左右されます。ほとんどの
オーディオソースは高域に大きなエネルギーを持たないため、ツイーターには通常あまり入力電力がかかりません。しかし、
ある種の入力（高周波の矩形波など）はツイーターに最大限のパワーを与え、安全閾値をすぐに超えてしまうことがあります。
もちろん、音量を安全なレベルに制限することもできますが、そうすると全体の音量が大幅に低下し、ほとんどの通常の音楽や
オーディオ信号に対して未使用のヘッドルーム(訳注:音割れしない限界)が多く残ってしまうことになります！

では、どうすればいいのでしょうか？最近のスピーカーアンプは、駆動しているスピーカーに流れる電流と電圧を測定する機能を備えており、
そこから瞬時の電力を計算することができます。この電力をスピーカーの物理的特性に基づいたモデルに入力することで、ボイスコイルの
温度（および完全なモデルに必要なマグネットの温度）を推定し、温度が上がりすぎた場合には音量を制限することができます。これは
[まさにmacOSが行っていること](https://github.com/AsahiLinux/linux/issues/53)であり、
Linuxで実装しなければならないことです。

この種の安全モデルは新しいものではありません。Android携帯ではすでに一般的で、通常DSPファームウェアに実装されています。
しかし、もちろん、デスクトップLinuxのエコシステムには、安全モデルどころか、まだスピーカーのEQデータベースフレームワーク
すらありません！ Linuxオーディオの永遠の遅れがまた襲ってきました。どうしましょうか？まだ確定したわけではありませんが、
現在のアイディアは、ALSA デバイスから電圧/電流のフィードバックデータを取得するスタンドアロンdaemonに安全モデルを実装し、
ソフトパワー制限を実装する手段としてミキサーのボリューム自体を駆動し、daemonがアクティブで動いているときだけ高い
ボリューム制限が可能になるカーネルとのある種の『安全ウォッチドッグ インターロック』と共に実現することです。
これは、出力デバイスを直接開いてデータを送ることができる個々の音声daemonやサブシステムから問題を遠ざけることに
なります（ただし、ハードウェアボリュームコントロールは使えませんが、データフォーマットが24ビットPCMなので、
ここではソフトウェアボリュームコントロールは完全に可能です）。

Appleはこの安全モデルをラップトップのM1 Pro/Maxシリーズから採用し始め、13インチM1 MacBook AirとProモデルには
実装されていません。しかし、スピーカーアンプはフィードバック機能に対応しているため、そちらについても独自の安全モデルを
開発し、実装する予定です。スピーカーのボイスコイルの温度は、銅が温度係数を持ち、温度によって抵抗値が変化することに基づき
推定可能なことがわかりました。スピーカーにパイロット信号を入力し電圧・電流をフィードバックすることで、コイルの抵抗値を
計算し、与えられた入力電力に対してボイスコイルの温度がどのように上昇するかを確認し、そのデータから新しい安全モデルの
正しい定数値を導出することができるのです。もしこのゲームでAppleを打ち負かせるなら、なんでやらないのですか？
(そして、もし私たちがこの研究を行い実装するなら、当て推量のソフトボリューム制限を考え出すのではなく、
これらのモデルの制限にもっと自信を持てるでしょう)。

というわけで、今のところスピーカーは使えないままですが、なんとかなりそうですよ！

## オーディオの進歩 トラック♫
一方で、[povik氏](https://github.com/povik/) はオーディオサブシステムに懸命に取り組んでいます！
14インチ/16インチMacBook Proシリーズ、Mac Studio、M2 MacBookで使用されている、新しい全く文書化されていない
CS42L84ヘッドフォン・コーデックをリバース・エンジニアリングしています。これは、全製品でヘッドフォンジャックに
対応できるようになったことを意味します!！また、この作業の多くをLinuxカーネルの上流に統合し、下流でのパッチ数を
低く抑えています。

さらに、PulseAudio/PipeWire や同様のオーディオサーバにこれを適切に統合し、ボリュームコントロールとホットプラグを
シームレスにする ``alsa-ucm-conf-asahi`` パッケージを現在提供中です。このパッケージは、今後予定されている
スピーカー対応にも使用され、デバイスの切り替えが適切に動作するようになります。とりあえず、
ヘッドフォン・ジャックを箱から出して使えるようにするには、パッケージをアップグレードして再起動するだけです!
ハードウェアのボリュームコントロールは、手動で設定しなくても、デスクトップのボリュームコントロールに自動的に
マッピングされるはずです。

この変更と他のオーディオの変更をテストしている間に、複数の PulseAudio のバグとリグレッションに遭遇し、ユーザーに
とって非常に悪い経験（アイドル状態やホットプラグ時に出力が停止する）が起こりました。次期スピーカーDSP構成は
PipeWireをベースにしていますが、PulseAudioをPipeWireに置き換えるだけで、奇妙な問題はすべて解決し、
他は完璧に動作することが分かりました。そのため、``asahi-desktop-meta``パッケージにPipeWireを依存関係と
して追加し、Asahi Linux Desktopイメージの既存のユーザはアップグレード時にPulseAudioを削除してPipeWireに
置き換えるよう促されることになります。未来を受け入れましょう！

## バックライト 第1巻
要望が多かったです！ ChaosPrincessのおかげで、キーボードバックライトに対応しました！ これは KDE とシームレスに
動作するので、これからはAsahi Mac は暗闇の中で光り輝くことができます。

これはChaosPrincessにとって初めてのドライバとリバースエンジニアリングの仕事でしたが、私はこの結果にとても満足しています。
これは非常にシンプルなドライバですが、ハードウェアの未知の部分をうまくマッピングして、リバースエンジニアリングによる
ハックではなく、ちゃんとしたドライバのようにしていました。これは、私たちがハードウェアの仕組みを理解するために
努力していることであり、新しい人々がこのアプローチに注目するのを見るのは、いつも楽しいことです。
ChaosPrincessのリバースエンジニアリングの経験を引用します。

```
1.run m1n1 (m1n1を実行)
2.poke at macos (macOSをいじる)
3.bang head against desk a lot. (机に何度も頭をぶつける）
4.??????　
5.profit, sometimes (時々利益を得る)
```

MacBookのキーボードが暗闇に光をもたらしますように！

## バックライト 第2巻
でも、ディスプレイの明るさはどうなんでしょう？

あ、もうちょっとです！ ご存知のように、これまでAsahi Linuxにはディスプレイドライバが全くありませんでした。
その代わり、ブートローダ（ノートパソコンではiBoot、デスクトップではm1n1）が設定するブート時のフレームバッファに
頼っています。つまり、Linux は単にメモリの塊を取得して、そこにピクセルを書き込むだけです。VSync もバッファフリップも
モード変更も DPMS もバックライト制御も対応していません。バックライトを点灯したままにするとバッテリーを大量に
消費するので、文字通りバックライトの電源を入れる GPIO ピンをオフにすることでバックライトの消灯に対応するハックを
追加しましたが、言うまでもなくこれは最高のユーザー体験ではありませんでした（そして多くのユーザーは、バックライトを
消そうとしたときに画面がオフになり困惑しました。現状のやや古い Linux バックライトインターフェイスには、0 が
『最低』なのか『実際のオフ』なのかどちらを意味するかユーザー領域に伝える方法がないためです）。

適切にディスプレイ出力に対応するためには、AppleのDCPコプロセッサとそのファームウェア用のドライバが必要です。
DCPについては、すでに
[話をしました](https://github.com/asfdrwe/asahi-linux-translations/blob/main/PROGRESS202108.md)が、
そのインターフェイスはなんて呪われているのでしょう！その後、
[Alyssa氏](https://social.treehouse.systems/@alyssa)がDCP用のLinuxカーネルDRM KMSドライバを書き、
[Janne氏](https://social.treehouse.systems/@janne)がメンテナンスを担当し、輝度調整対応など、着実に機能を
追加しています。これでようやく、DCPは冒険好きなユーザーがM1システムで日常的にドライブするのに十分な性能になりました！
（M2対応はもうすぐです）。

ブートローダハックなしで1080p以上のディスプレイを駆動する能力や輝度制御、VSync（Wayland上）、解像度切り替えなど、
長らく欠けていた多くの機能をこれが修正します。また、Sven氏が取り組んできた（まだ不完全な）外部ディスプレイ対応（Type C/DisplayPort上）にも
道を開き、Lina氏の次期アクセラレーションGPUドライバの必要条件となります。進歩です！

ただし、いくつかの注意点があります。ドライバは複雑で、バグやリグレッションが発生する可能性があり、一部のセットアップでパフォーマンスが減少するかもしれません。というのも、GPUアクセラレーション（simpledrmフレームバッファドライバはDCPにないソフトウェア
レンダリングの最適化が存在）とWaylandコンポジターのような最新のatomic-modesetとスワップAPIを使うクライアントと共に使うことを
意図しているからです。また、Xorgのようなレガシークライアントで使用する場合、いくつかの制限があります。
特に、真の VBlank 割り込みサポートがなく、ハードウェア/ファームウェアがこれに全く対応していないのか不明です。
これは、コンポジットが有効になっている XFCE4 のウィンドウマネージャを壊します。これらの理由から、すべてのユーザーに対して
デフォルトでDCPを有効にせず、代わりにオプトインの機能にしました。どうやっているのですか？それは...

## Edgeでの生活
DCPのような新しい最先端のドライバは、既存のユーザーの体験を後退させる危険性があります。多くの人がこれらの新機能を待ち望んでいる一方で、他の多くの人はすでに既存のカーネルで毎日 Asahiをドライブしており、その体験が安定したままであることを望んでいます。
私たちは開発パッケージのリポジトリ (``asahi-dev``) を持っていますが、定期的にうまく動かないパッケージを含んでおり、
エンドユーザ向けではありませんし、通常の ``asahi`` リポジトリと行き来するのは困難です (``asahi-dev`` は使わないでください、本当に。また、他の人に使うように`教えないでください`)。

その代わりにこうしています。このリリースから、新しい ``linux-asahi-edge`` カーネルパッケージを提供しました。これにはまだ全ユーザに
配布できるほど安定しているとは言えないドライバや設定が含まれています。
このパッケージは、既存の ``linux-asahi`` パッケージと並行してインストールでき、デフォルトのブートエントリになりますが、
GRUB の高度なブートオプションを使えば、いつでも非 edge カーネルにフォールバックすることが可能です。これを使うには、
単にパッケージをアップグレードして、これをインストールし、GRUB の設定を更新するだけです。

```
$ sudo pacman -Syu
$ sudo pacman -S linux-asahi-edge
$ sudo update-grub
```

これは最先端のカーネルなので、このカーネルに関する問題を新しいバグとして私たちのトラッカーに報告しないようお願いします
（すでにそれらの多くについて知っています！）。その代わりに、[この](https://github.com/AsahiLinux/linux/issues/70)
トラッカーバグにコメントを残し、他のスレッドで言及された既知の問題でないことを確認してください。時間をかけて問題への行動順位を
決定し、ドライバが成熟するのに従い最終的にメインカーネルに昇格していきます。

``linux-asahi-edge`` は ``linux-asahi`` と同じカーネルツリーを追跡し、特定の機能を有効または無効にするために
ビルド時の設定を変更するだけであることに注意してください。システムを壊さないために、もしインストールしてあるなら、
常に両方のパッケージを同時にアップグレードする必要があります（``pacman -Syu`` だけで大丈夫です）。これを怠ると
DeviceTreeの不一致が起こり、2つのカーネルのうちどちらかが起動不能になる可能性があります。

前のリンクをクリックした熱心な人はそこに書いてある他のことに気づいたかもしれません...そうです、One More Thing™ があります！

## アイドル状態の思想

DCPの次に要望が多いのが『電源管理』です。とても面白いです。というのも、当初から電源管理を搭載していたからです！
CPU周波数のスケーリング、デバイスランタイム電源管理（一部のデバイスを対象）、ハードウェア自動電源管理...
このリリース以前でも、ユーザーはすでに10時間以上アイドル状態で実行できました。
DCPと適切なディスプレイDPMSを使えば、30時間以上にもなります（電源オン、画面オフ）！

でも、『電源管理』というと、普通は『サスペンド』を意味しますよね。古代のx86プラットフォーム（『古代の』というのは
『2015年以前のすべてのもの』という意味）には、Apple Silicon Macのような合理的なリアルアイドル電力管理はありません。
その代わりに、グローバルな『サスペンド』または『S3』モードを実装し、ハードウェアのほとんどをオフにして、
RAMだけをオンにしたままにします。というのも、当時の機器では、ノートパソコンのバッテリーを数時間で完全に
使い切ってしまわないようにするためには、それしか方法がなかったからです。

ありがたいことに、スマートフォンのようなSoCベースのシステムでは、長い間ずっと優れた電力管理が行われてきました。
IntelやMicrosoftもこれに乗り出し、今では『S0ix』または『モダンスタンバイ』と呼ばれるものに対応しています。
きめ細かな電力管理を行うプラットフォームでは、電力を節約するためにシステムを『中断』する必要はありません。
機器をアイドル状態にしておくだけで、すでに電力が節約されているのです！

もちろん、『機器をアイドル状態にする』にはOSによる少しの助けがないと難しいことです。Linux では、
S0iX に相当するものは 『s2idle』 (Suspend-to-idle) と呼ばれ、まさにその言葉通り、システムを
サスペンドする動作に入りますが、プラットフォームファームウェアを介して実際にフルシステムのサスペンドを引き起こす代わりに、
ハードウェアをアイドル状態にするだけになります。重要なのは、これはユーザ空間を凍結し特定のデバイスを低電力モードにすることで、
s2idleは、単にアプリを実行したままではできないような `省電力化を保証すること` ができます。Asahi Linux機器で、アイドル時に
バッテリーの消耗が激しいという報告がありますが、これは、ほとんどの場合、ユーザ空間の扱いが悪いために、
大量のウェイクアップが発生したり、CPUがビジー状態になっていることが原因です。s2idleがこの問題を解決します！

s2idleは、特別なドライバやサポートを必要としませんが、ドライバでサスペンド/レジュームが動作する (つまり、
少なくとも失敗しない) ことが必要です。私たちにとって、これはWiFiチップセットでブロックされており、Apple機器で
S3サスペンド（紛らわしい名前、s2idleにマップ）と呼ばれる新しいメカニズムを必要とし、既存のドライバでは対応して
おらず、サスペンドプロセスがエラーになる原因になっていました。このドライバと、その他いくつかのマイナーなドライバを
実装した結果、s2idleはApple Silicon機器でも動作するようになりました！
``linux-asahi-edge`` カーネルではこの機能が有効になっているので、切り替えれば、デスクトップ環境に魔法のように
サスペンドオプションが現れるはずです。

s2idleは動作しますが、まだ初期段階であり、全てのドライバの問題をデバッグしているわけではありません。以下は、その動作です:

- NVMeがシャットダウン
- WiFi は S3 モードに
- ディスプレイ (DCP) が DPMS に移行 (バックライトと画面が完全にオフ)
- DARTs はパワーゲートし、レジューム時に状態を復元
- CPU はシャローアイドルを維持
- いくつかの雑多なデバイス (i2c/spi/etc) の電源オフ
- 電源ボタンまたは蓋を開くとウェイクアップ

そして、少なくともこれらのものは、欠落しているか、壊れていることが知られています:

- CPUのディープ/パワーオフアイドルなし(通常のランタイムにも影響、PSCI交換でブロック)
- USB2/3がうまく動かない (コントローラがリセットされ、レジューム時にデバイスの再接続が必要になる場合あり:`USBドライブをmountしたままサスペンドしないで`）
- 一部のデバイスはまだサスペンドされない (例: キーボード/トラックパッドはキーストロークをバッファリングするのでうまくうごかない可能性あり)
- 代替のウェイクアップソースなし (キーボード/マウス/その他)

これらの問題は時間をかけて解決していく予定ですが、皆さんに現状のs2idleを試していただく機会を設けたいと思います。
先に述べたように、問題があれば、[linux-asahi-edge trackerのissue](https://github.com/AsahiLinux/linux/issues/70)に
ご報告ください。

最後に、Apple Silicon Macは、システム全体をより深いスリープ状態にする『真の』S3的なサスペンドモードに対応しており、
これはmacOSがサスペンドに使用しています。これはより大きな電力削減をもたらすかもしれませんが、実装がより複雑で、
まだ解決していないいくつかの事柄に依存します。今のところ、s2idleの消費電力を減らすための低いぶら下がり果実がまだあるので、
今後はそちらに焦点を当てることにします。将来的には、『フル』サスペンドが、適切に管理されたs2idleよりも大きなメリットを
もたらすことがわかれば、こちらを実装するかもしれません。

## インストーラをもう一度

新規ユーザー向けの Asahi Linux インストーラにも取り組んでいます。長い話を短くすると、以前のバージョンの問題点
（macOSのリサイズ時の安全な制限を計算する問題でリサイズエラーが発生するなど）を多く修正し、また、いくつかの
プロンプトの文言をより明確にするために改善しました。これで、よりスムーズで混乱しづらい体験ができるようになったはずです！

さらに、M2サポートを非エキスパート向けにも推進しました。M1ファミリーの12.3と同様に、M2の12.4ファームウェア・バージョンに
対応することを約束します。注意点として、ファームウェアのバージョンというのは、インストーラがAsahi Linuxと一緒に
インストールする`OSと対になる`ファームウェアのことを指します。これは、macOSのバージョンとは無関係で、インストーラーは、
12.3から13.xまで、現在のすべてのmacOSのバージョンに対応しています。

また、インストーラーの新機能として、以下の2つがあります。壊れたインストールを復旧でき、m1n1 第1ステージ バージョンを
アップグレードできます。時々、ユーザーはインストール後（ステップ2）の指示に正しく従わず、ブートループに陥ることが
あります。これはシステムをシャットダウンして再試行すれば簡単に直りますが、他のこと (別の起動 OS を選択するなど) を
するとインストールが変な状態になり、パーティションを消してゼロから再インストールしないと、再試行が難しくなります。
インストーラは、『不完全なインストール』を修復する新しい機能を提供します。これは、基本的にプロセスの最後のステップを
再実行し、完全な再インストールを必要とせずに、インストール後の指示に再び従うようユーザに促します。

この仕組みは、AppleのmacOSアップグレードプロセスが混乱し、Asahi Linuxのブートポリシーを削除または
再作成してしまってインストールが壊れてしまう稀なケースからの回復にも有用です。このようなことがごくまれに
起こることを確認しています（確実に再現する方法を見つけた場合は、ぜひお知らせください！）。この問題が
発生した場合の解決方法は簡単なので、ユーザは安心してください。インストーラをもう一度実行し (macOS または 
recoveryOS からは ``curl https://alx.sh | sh``)、プロンプトが出たら repair オプションを選択する
だけです (状況は不完全なインストールと同じ)。

新しい m1n1 アップグレード機能は、m1n1 第1ステージ バージョンをアップグレードするために使用します。Asahi Linuxの
インストールでは、m1n1には2つのステージがあり、第2ステージは常にLinuxパッケージを介してアップグレードされ、
新機能を追加するために最も重要な部分です。第1ステージはrecoveryOSからインストールされ、Linuxからアップグレードする
ことはできず、その仕事は第2ステージをロードすることだけです。それしかしないので、アップグレードする必要はほとんどありません。
しかし、稀なバグを修正するのに役立つことがあり、稀にクリーンシャットダウン後にブート失敗が続く問題が確認されています。
回避策は簡単ですが（電源ボタンを押しながら起動し、再度Asahiを選択すれば障害は解消します）、新しいm1n1バージョンでは
この問題を完全に解決できるはずですので、アップグレードすることをお勧めします。macOSまたはrecoveryOSから通常通り
インストーラーを実行（``curl https://alx.sh | sh``）し、プロンプトが出たらオプションを選択するだけです。Asahi
インストールとペアになっている recoveryOS から実行すると (つまり、Asahiがデフォルトの起動 OS であるときに
電源ボタンを押し、オプションを選択する)、通常の強制再起動ステップを回避することも可能です。

最後に、m1n1（プロキシモードのみ）を外付けUSBドライブにインストールするエキスパート専用の実験的な新機能があります。
何度も言っているように、Apple Silicon機器は USB ブートに対応していません。しかし、AppleはUSBドライブから
OSブートファイル（カーネル、ブートローダ、ファームウェア）を内蔵NVMeストレージの予約パーティションにコピーする
ことでこれを偽装しています。インストーラは、サードパーティ製OSであってもこの仕組みを利用し、内部ストレージの
再パーティションを必要とせず、m1n1の『完全なUSB』インストールを行うことができるようになったのです。
インストール完了後に USB ドライブを抜くと、面白いことに、ブートピッカーから他のブート OS を選択するまで、機器は
とにかく m1n1 でコールドブートを続けます (言ったでしょ、USB ブートは偽物です！)。この USB ドライブは
自動的に他の Mac に移植できるわけではありませんが、理論的にはインストーラの『修復インストール』オプションを
使えば、新しい Mac で外部の m1n1 USB ドライブを起動可能にできるはずですが、まだテストしていないので、
おそらく現時点で同じタイプ/モデルの機器でない場合は問題があるでしょう。

残念ながら、m1n1 ステージ1はUSBホストをサポートしていないので、これで真の『完全な外部』Asahi Linuxインストールは
まだできません... 誰かRust USBスタックとxHCIホストコントローラドライバの開発に着手しませんか？;-)

## エピローグ
いつものように、既存のユーザーに対しては、``sudo pacman -Syu`` でシステムをアップグレードして再起動するだけで
すべての新機能を手に入れることができます。これは新しいファームウェアのメカニズムへの移行とその他全てを処理します。
みんなのために物事をシンプルに保ちたいのです！ 今回は、``sudo update-grub`` を実行して GRUB ブートローダが
最新であることを確認し (これは通常のパッケージアップグレードには含まれません)、前述のオプションだが推奨される 
m1n1 ステージ 1 アップデートについてもメモしておくことをお勧めします。

これはLinux のインストールを最新の状態に保つよう、皆さんに注意を喚起する良い機会でしょう！macOS Ventura ベータの
初期に、アップグレード後に Linux が起動しなくなる問題が見つかりました。何ヶ月も前にパッケージのアップデートで
修正しましたが、今でも Ventura (あるいは最新の 12.x macOS リリースにも同じ問題あり)にアップグレードしたユーザが、
その間にアップグレードしなかったために Linux インストールを起動不能にしてしまうということがあります。macOS の
アップグレードが Linux を壊滅的に破壊するようなこの種の問題は稀であるべきで、ベータ版をテストして早期に
発見するようにしていますが、トラブルを避けるためには、ユーザが OS をアップデートしておくことを当てにしています。
アップデートしてください！ Arch Linux のアップデートも長い間していないと、かなり厄介なことになります。
だからこそする必要があるのです。

あ、そうそう、GPUですね。そうです。忘れるわけないですよ！ ねぇリナ？来週、GPUの現状をブログで紹介することになるよ。
言い訳しないでね！

![Apple M1でのXonotic](https://asahilinux.org/img/blog/2022/11/xonotic.png)

#### marcan · 2022-11-22

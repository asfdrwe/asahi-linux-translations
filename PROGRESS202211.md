[Updates galore! November 2022 Progress Report](https://asahilinux.org/2022/11/november-2022-report/)の非公式日本語訳です。

訳注
- 作業中: まだDeepLの結果を貼っただけのもの＋一部翻訳修正 (2022/11/23)
- ブログへのリンクを対応する日本語訳ページへのリンクに置き換え

---
# アップデート満載！ 進捗報告:2022年11月

- [前回](https://github.com/asfdrwe/asahi-linux-translations/blob/main/PROGRESS202207.md)

また遅ればせながら進捗報告の時間がやってまいりました。今月のアップデートでは、新しいハードウェアの対応や新機能や長年の問題点の修正に加え、
待望のサスペンドとディスプレイコントローラに対応した最先端カーネルブランチが詰め込まれています！

Asahi Linuxに初めて触れる方は、[以前のリリース告知](https://github.com/asfdrwe/asahi-linux-translations/blob/main/PROGRESS202203.md)にある
インストール方法と一般的な情報をご覧ください。

## USB3 第1章

これまで、Asahi Linuxは、ThunderboltポートのUSB2のみ対応していました。ハードウェアのUSB2/3コントローラは既にLinuxでそこそこ対応しており、
Type-Cポートのコントローラも既存の一部対応しているハードウェアをベースにしていますが、大きな欠落部分がありました。PHYドライバです。

M1以降のApple Silicon機器は、USB3、DisplayPort、TB3/USB4モードに対応する『Apple Type-C PHY』（ATCPHY）というAppleが設計した
（あるいはAppleがカスタマイズした？）PHYハードウェアを使用しています。このハードウェアはUSB3/DP/TBプロトコルのデータを配線上の
信号にする役割を担っています。非常に高速な信号（ペアあたり最大20Gbps）を扱うため、PHYは非常に複雑で、個別に校正する必要のある
アナログつまみがたくさんあります。USB2 ではどのデバイスでも動作する普遍的な設定で済みますが、USB3やより高速なプロトコルではそうはいきません！

PHY ドライバの仕事は、工場で校正された特定のチップに特有の設定で物理的ハードウェアを構成することであり、異なるモードが切り替わったときに 
PHY ハードウェア全体の再構成を管理することです。実際には、これは、工場で書かれた電子ヒューズ から来る可変データを含む、膨大な数の『マジック』レジスタへの
書き込みを意味します。[Sven氏](https://social.treehouse.systems/@sven) は、これら全てのリバースエンジニアリングに取り組み、この新しい
リリースには、USB3 モードに対応する新しい ATCPHY ドライバが含まれています！

PHY 自体の駆動に加えて、PHY ドライバは、USB コントローラドライバ (``dwc3``) とタイプ C ポートコントローラドライバ (``tipd``) とを
大変慎重に調整しなければなりません。デバイスが接続されたり外されたりするとき、複雑なネゴシエーションのダンスが起こり、最終的に、
どのワイヤ上でどのプロトコルを実行するかを決定することにつながります。この情報はPHY が適切に信号をルーティングできるよう
PHY に伝えられなければならず(ケーブルをどのような向きで差し込んだかなども含む）、全てが正しい順序で初期化された後に、
USB コントローラが起動されます。さらに厄介なことに、このハードウェアは非常に気まぐれで、何か問題が起きるとコントローラがロックしたり動作
しなくなったりする可能性があります！

USB3モードはかなり堅固だと思いますが、デバイスを素早くホットプラグするようなことをするときには、いくつかの不具合が予想されます。
ただし、ケーブルのホットプラグによるモード切り替えは、ほぼすべてをリセットすることになるので、一時的な問題であれば、デバイスの接続を
解除して再接続すれば解決することが多いでしょう。実際のUSB3の動作は一度接続すれば問題ないはずですが、何か問題が発生した場合はご連絡ください。

# ここまで作業済み(2022/11/23)

## USB3 第2x7章 Gen3.1415

Mac StudioとiMacにはType-Aと非Thunderbolt Type-Cのポートがあります。これらのポートは、ASMedia PCIe USB3コントローラによって処理されます（ハードウェアのモデルによって組み合わせは異なります）。これは単なる標準的な USB PCIe xHCI コントローラで、Linux の標準ドライバですでに十分にサポートされていますが、Apple Silicon プラットフォームでは、コントローラはドライバによってアップロードされるファームウェアを必要とします！通常、この種のハードウェアは、Apple Silicon プラットフォームではファームウェアが必要です。

通常、この種のハードウェアは、コントローラを実行するためのファームウェアを含むフラッシュメモリと共に出荷されることが期待されています。しかし、AppleはランダムなFlashメモリをあまり好みません。それには理由があり、Flashメモリは危険であり、破損する可能性があり、検証やセキュアブートの実装が困難だからです。このため、Apple のエンジニアは、これらのプラットフォームのファームウェア Flash メモリの数を着実に減らしてきており、今回は、単にそれなしで出荷し、起動時にカーネルがファームウェアをアップロードするようにすることにしたのです。

これは単純な問題に見えるかもしれませんし、実際にファームウェアのアップロードはほとんどそうです（これを行うために必要な文書化されていないレジスタのダンスは、理解して確実に動作させるのがそれほど簡単ではありませんでしたが...）が、結局、私たちは Asahi Linux でファームウェアを扱う方法を完全に考え直さなければなりませんでしたし、インストーラに変更を加えて新しいソフトウェアパッケージとベンダーバイナリを出荷しなければなりませんでした

ASMediaのファームウェアは、macOSのXNUカーネルバイナリに組み込まれているため、Linuxで利用できるようにするためには、それを抽出する必要があることが判明しました。私たちは、この問題が起こることを知っていたので、将来インストーラで使用するために、そのカーネルのコピーを/boot/efi/asahi/に隠しておきました。しかし、このカーネルは img4 フォーマットで、Apple が開発した lzfse アルゴリズムで圧縮されているため、結局、既存の Asahi ユーザがシームレスにアップグレードし、ファームウェアが自動的に抽出されるように、これを新しいパッケージとして出荷しなければならなくなりました。

一方、macOSでは、新規インストール時にAsahi Linux Installer内で同じ処理を行う必要があります。macOSにはもちろんlzfseをサポートする独自の圧縮フレームワークが同梱されており、ctypeを使ってPythonから直接使うことができます。これはmacOSでは動作しますが、recoveryOSにはPythonがctypesを動作させるために必要なlibffiが同梱されていないことが判明しました。そのため、macOS と recoveryOS のどちらからインストーラを実行してもシームレスに動作するように、（Homebrew パッケージの）libffi のコピーをインストーラと一緒にベンダリングしなければならなくなったのです。

さらに、このファームウェアは、Asahi のベンダー・ファームウェアのメカニズムを完全に再設計することになりました。これまで、私たちは、initramfs が仕事をした後、起動した OS からファームウェアをロードすることだけ で済ませていました。これは、WiFiやBluetoothのファームウェアについては十分に機能しますが、人々は通常、キーボードがinitramfsの中で動作することを期待しており、そのキーボードはASMedia xHCIポートの1つに接続されているかもしれません。その上、私たちが最初に設計したベンダーファームウェアをインストールする仕組みは、WiFi/BTハードウェアが初回起動時にファームウェアの準備ができる前にカーネルによって検出される可能性があるという点で無茶でした（特にM2マシンで、インストール後の最初の起動時にWiFiが壊れることがあるのはこのせいです）。これは大きな変化の時でした。

新しい仕組みは、更新された Open OS Ecosystem on Apple Silicon Macs ページに記載されていますが、その要点は以下の通りです。私たちはファームウェアパッケージのフォーマットを tarball から cpio アーカイブに変更し、initramfs でそれを何よりも先に tmpfs にロードし、最終的にルートファイルシステム上の tmpfs マウントを使ってそれを保持するようにしました。これはまた、パッチでカーネルに新しいファームウェアのロードパスを追加することも含んでいます。initramfsは、udevが起動する前に(したがって、それを必要とするドライバがロードされる前に)ファームウェアがロードされることを保証することができるので、最終結果は、はるかに堅牢で、法的にもより安全なシステムであり、ルートファイルシステム内に永続することも、ディストロによって提供されるファームウェアと混合する(例えば、linux-firmware)こともありません。さらに、アーカイブが cpio であるため、ブートローダがブート時にアドオン initramfs としてロードすることができ、組み込みドライバと一緒に動作することができ、すべての可能な競合状態を完全に排除することができます。Asahi Linux では、現在、デフォルトではこれを行いませんが、/boot を再構成して EFI システムパーティションを直接マウントし、そこにカーネルとブートローダをインストールすれば、サポートされる設定です（将来、これを行うための手順を提供します。現時点では、自己責任ですが、 asahi-scripts パッケージは両方のレイアウトをシームレスにサポートするはずです）。cpio がブートローダによってロードされていない場合、initramfs スクリプトがそれを探してロードしてくれるので、どちらの構成も同じような結果になります。

ふぅー! ASMediaのファームウェアをロードするのは、かなりの冒険でしたね。しかし、これですべてのマシンでファーストブートWiFiが強固になり、今後のファームウェア管理設計に自信を持つことができました。

## オーディオの進化、トラック♪」

スピーカーはどうなんだ、という声が聞こえてきそうです。その通りです。というのも、もっと複雑な音量制限や安全システムがないと、スピーカーを破壊してしまうのではないかという強い疑念があったのです。結果的には...その疑いは正しかったのです! 私はチームのために、MacBook Air M2でいくつかのテストを行うことにしましたが、常識的な音量制限を設けても、すぐにトゥイーターを爆発させることに成功しました。おっと！？まだスピーカーを有効にしていなくてよかった。

この実験をきっかけに、スピーカーを安全に駆動するために何が必要なのかを詳しく調べてみたところ、その答えは予想以上に複雑でした。最新のマイクロスピーカーは、良い音を出すために高度なソフトウェアEQが必要ですが、同時に高度な安全モデルも必要なのです マイクロスピーカーにとって最も重要な安全パラメータは、ボイスコイルの温度である。しかし、スピーカーがどの程度熱くなるかは、スピーカーにどれだけの電力が供給されているかに左右される。ほとんどのオーディオソースは高域に大きなエネルギーを持たないため、トゥイーターには通常あまり入力電力がかかりません。しかし、ある種の入力（高周波の矩形波など）はトゥイーターに最大限のパワーを与え、安全閾値をすぐに超えてしまうことがあります。もちろん、音量を安全なレベルに制限することもできますが、そうすると全体の音量が大幅に低下し、ほとんどの通常の音楽やオーディオ信号に対して未使用のヘッドルームが多く残ってしまうことになります

では、どうすればいいのでしょう？最近のスピーカーアンプは、駆動しているスピーカーに流れる電流と電圧を測定する機能を備えており、そこから瞬時の電力を計算することができます。この電力をスピーカーの物理的特性に基づいたモデルに入力することで、ボイスコイルの温度（および完全なモデルに必要なマグネットの温度）を推定し、温度が上がりすぎた場合には音量を制限することができます。これはまさにmacOSが行っていることであり、私たちはLinuxで実装しなければならないことです。

この種の安全モデルは新しいものではありません。Android携帯ではすでに一般的で、通常DSPファームウェアに実装されています。しかし、もちろん、デスクトップLinuxのエコシステムには、安全モデルどころか、まだスピーカーのEQデータベースフレームワークすらありません Linuxオーディオの永遠の遅れが、またもや襲ってきました。どうするんですか？まだ確定したわけではありませんが、私たちの現在のアイディアは、ALSA デバイスから電圧/電流のフィードバックデータを取得するスタンドアロン デーモンに安全モデルを実装し、ソフトパワー制限を実装する手段としてミキサーのボリューム自体を駆動し、デーモンがアクティブで動いているときだけ高いボリューム制限が可能になるカーネルとのある種の「安全ウォッチドッグ インターロック」と共に実現することです。これは、出力デバイスを直接開いてデータを送ることができる個々のオーディオデーモンやサブシステムから問題を遠ざけることになります（ただし、ハードウェアボリュームコントロールは使えませんが、データフォーマットが24ビットPCMなので、ここではソフトウェアボリュームコントロールは完全に許容されます）。

Appleはこの安全モデルをノートパソコンのM1 Pro/Maxシリーズから採用し始め、13インチM1 MacBook AirとProモデルには実装されていない。しかし、スピーカーアンプはフィードバック機能に対応しているため、そちらについても独自の安全モデルを開発し、実装する予定です。スピーカーのボイスコイルの温度は、銅が温度係数を持ち、温度によって抵抗値が変化することから推定できることがわかりました。スピーカーにパイロット信号を入力し、電圧・電流をフィードバックすることで、コイルの抵抗値を計算し、与えられた入力電力に対してボイスコイルの温度がどのように上昇するかを確認し、そのデータから新しい安全モデルの定数を導出することができるのです。アップル社に勝てるなら、やってみようじゃないか。なぜなら、もし私たちがAppleのゲームに勝てるなら、勝てるはずだからです(そして、もし私たちがこの研究を行い、それを実行するなら、当て推量のソフトボリューム制限を考え出すのではなく、これらのモデルの制限にもっと自信を持つことができるでしょう)。

というわけで、今のところスピーカーは使えないままですが、なんとかなりそうです。

## オーディオの進歩、トラック♫」。

一方、povikはオーディオサブシステムに懸命に取り組んでいます! 彼は、14インチ/16インチMacBook Proシリーズ、Mac Studio、M2 MacBookで使用されている、新しく、完全に文書化されていないCS42L84ヘッドフォン・コーデックをリバース・エンジニアリングしています。これは、私たちが全製品でヘッドフォンジャックをサポートできるようになったことを意味します。また、この作業の多くをLinuxカーネルにアップストリームし、ダウンストリームのパッチ数を低く抑えています。

さらに、PulseAudio/PipeWire や同様のオーディオサーバにこれを適切に統合し、ボリュームコントロールとホットプラグをシームレスにする alsa-ucm-conf-asahi パッケージを現在出荷中です。このパッケージは、今後予定されているスピーカーのサポートにも使用され、デバイスの切り替えが適切に動作するようになります。とりあえず、ヘッドフォン・ジャックを箱から出して使えるようにするには、パッケージをアップグレードして再起動するだけです! ハードウェアのボリュームコントロールは、手動で設定しなくても、デスクトップのボリュームコントロールに自動的にマッピングされるはずです。

この変更と他のオーディオの変更をテストしている間、複数の PulseAudio のバグとリグレッションに遭遇し、ユーザーにとって非常に悪い経験（アイドル状態やホットプラグ時に出力が停止する、など）となりました。私たちのスピーカーDSPはPipeWireをベースにしていますが、PulseAudioをPipeWireに置き換えるだけで、すべての奇妙な問題が解決し、それ以外は完璧に動作することが分かりました。そのため、asahi-desktop-metaパッケージにPipeWireを依存関係として追加し、Asahi Linux Desktopイメージの既存のユーザは、アップグレード時にPulseAudioを削除してPipeWireに置き換えるよう促されることになります。未来を受け入れよう

## バックライト 第1巻

皆さんから要望が多かった! ChaosPrincessのおかげで、キーボードバックライトがサポートされました! これは KDE とシームレスに動作するので、あなたの Asahi Mac は暗闇の中で輝くことができます。

これはChaosPrincessにとって初めてのドライバとリバースエンジニアリングの仕事でしたが、私はこの結果にとても満足しています。これは非常にシンプルなドライバですが、ハードウェアの未知の部分をうまくマッピングして、リバースエンジニアリングによるハックではなく、ちゃんとしたドライバのように見えるようにしました。これは、私たちがハードウェアの仕組みを理解するために努力していることであり、新しい人々がこのアプローチに注目するのを見るのは、いつも楽しいことです。彼らのリバースエンジニアリングの経験を引用します。

        m1n1を実行する
        Macosをいじる
        机に頭をぶつけまくる。
        ??????
        時々、利益を得る

MacBookのキーボードが暗闇に光をもたらすように!
## バックライト、ブックII

でも、ディスプレイの明るさってどうなんだろう？

あ、もうちょいだ! ご存知のように、これまでアサヒリナックスにはディスプレイドライバが全くありませんでした。その代わり、ブートローダ（ノートパソコンではiBoot、デスクトップではm1n1）が設定するブート時のフレームバッファに頼っています。つまり、Linux は単にメモリの塊を取得して、そこにピクセルを書き込むだけです。VSync もバッファフリップもモード変更も DPMS もバックライト制御もサポートされていません。バックライトを点灯したままにするとバッテリーを大量に消費するので、私たちは、文字通りバックライトの電源を入れる GPIO ピンをオフにすることでバックライトの消灯をサポートするハックを追加しましたが、言うまでもなくこれは最高のユーザー体験ではありませんでした（そして多くのユーザーは、バックライトを消そうとしたときに画面がオフになり困惑しました、現在やや古い Linux バックライトインターフェースには、0 が「最低」または「実際のオフ」を意味するかをユーザー領域に伝える方法がないためです）。

ディスプレイ出力を適切にサポートするために、AppleのDCPコプロセッサとそのファームウェア用のドライバが必要です。DCPについては、過去にすでに話をしましたが、そのインターフェイスがいかに呪われたものであるか！？その後、AlyssaがDCP用のLinuxカーネルDRM KMSドライバを書き、Janneがメンテナンスを担当し、輝度調整のサポートなど、着々と機能を追加しています。これでようやく、DCPは冒険好きなユーザーがM1システムで日常的にドライブするのに十分な性能になりました！（M2対応はもうすぐです。）

これは、ブートローダハックなしで>1080pディスプレイを駆動する能力、輝度制御、VSync（Wayland上）、解像度切り替えなど、長らく欠けていた多くの機能を修正するものです。また、Svenが取り組んできた（まだ不完全な）外部ディスプレイのサポート（Type C/DisplayPort上）にも道を開き、Linaの次期アクセラレーションGPUドライバの必要条件となります。進歩だ!

ドライバは複雑で、バグやリグレッションが発生する可能性があります。また、GPUアクセラレーション（simpledrmフレームバッファドライバはDCPにないソフトウェアレンダリングの最適化があります）とWaylandコンポジターのような最新のアトミックモデセットとスワップAPIを使うクライアントと共に使うことが本当に意図されているので、一部のセットアップでパフォーマンスが減少するかもしれません。特に、真の VBlank 割り込みのサポートがなく、ハードウェア/ファームウェアがこれを全くサポートしていないのか不明です。これは、コンポジットが有効になっている XFCE4 のウィンドウマネージャを壊します。これらの理由から、私たちはすべてのユーザーに対してデフォルトでDCPを有効にせず、代わりにオプトインの機能にすることにしています。どうやるのかって？それは...

## エッジに生きる

DCPのような新しい最先端のドライバは、既存のユーザーの体験を後退させる危険性があります。多くの人がこれらの新機能を待ち望んでいる一方で、他の多くの人はすでに既存のカーネルで毎日 Asahi を運転しており、その体験が安定したままであることを望んでいます。私たちは開発パッケージのリポジトリ (asahi-dev) を持っていますが、定期的に壊れたパッケージを含んでおり、エンドユーザ向けではありませんし、通常の asahi リポジトリと行き来するのは困難です (asahi-dev を使わないでください、本当に。また、他の人に使うように教えないでください)。

その代わり、こんなことをやっています。このリリースから、私たちは新しい linux-asahi-edge カーネルパッケージを出荷しています。このパッケージは、既存の linux-asahi パッケージと並行してインストールでき、デフォルトのブートエントリになりますが、 GRUB の高度なブートオプションを使えば、いつでも非 edge カーネルにフォールバックすることが可能です。これを使うには、単にパッケージをアップグレードして、これをインストールし、GRUB の設定を更新するだけです。

$ sudo pacman -Syu
$ sudo pacman -S linux-asahi-edge
$ sudo update-grub

これは最先端のカーネルなので、このカーネルに関する問題を新しいバグとして私たちのトラッカーに報告しないようお願いします（私たちはすでにそれらの多くについて知っています！）。その代わりに、このトラッカーバグにコメントを残し、それが他のスレッドで言及された既知の問題でないことを確認してください。我々は、ドライバが成熟し、最終的にメインカーネルに昇格するにつれて、時間をかけて問題をトリアージしていきます。

linux-asahi-edge は linux-asahi と同じカーネルツリーを追跡し、特定の機能を有効または無効にするためにビルド時の設定を変更するだけであることに注意してください。システムを壊さないために、もしインストールしてあるなら、常に両方のパッケージを同時にアップグレードする必要があります（pacman -Syu だけで大丈夫です）。これを怠るとデバイスツリーの不一致が起こり、2つのカーネルのうちどちらかが起動不能になる可能性があります。

前のリンクをクリックした熱心な人はそこに書いてある他のことに気づいたかもしれません...そうです、One More Thing™ があります!

## \⑭アイデア

DCPの次に要望が多いのが、「電源管理」です。というのも、私たちは当初からパワーマネージメントを搭載していたからです。CPU周波数のスケーリング、デバイスランタイムPM（一部のデバイスを対象）、ハードウェア自動PM...このリリース以前にも、ユーザーはすでに10時間以上のアイドルランタイムを得ることができました。DCPと適切なディスプレイDPMSを使えば、30時間以上にもなります（電源オン、画面オフ）!

でも、「電源管理」というと、普通は「サスペンド」を意味しますよね。古代のx86プラットフォーム（「古代の」というのは「2015年以前のすべてのもの」という意味です）には、Apple Silicon Macのような合理的なリアルアイドル電力管理はありません。その代わりに、グローバルな「サスペンド」または「S3」モードを実装し、ハードウェアのほとんどをオフにして、RAMだけをオンにしたままにします。

ありがたいことに、スマートフォンのようなSoCベースのシステムでは、長い間ずっと優れた電力管理が行われてきました。IntelやMicrosoftもこれに乗り出し、今では「S0ix」または「モダンスタンバイ」と呼ばれるものをサポートしています。きめ細かな電力管理を行うプラットフォームでは、電力を節約するためにシステムを「中断」する必要はありません。マシンをアイドル状態にしておくだけで、すでに電力が節約されているのです。

もちろん、「マシンをアイドル状態にする」ことは、OSのちょっとした助けがないと難しいことです。Linux では、S0iX に相当するものは "s2idle" (Suspend-to-idle) と呼ばれ、まさにその言葉通り、システムをサスペンドする動作に入りますが、プラットフォームファームウェアを介して実際にフルシステムのサスペンドを引き起こす代わりに、ハードウェアをアイドル状態にするだけになります。重要なのは、これはユーザ空間を凍結し、特定のデバイスを低電力モードにすることで、s2idleは、単にアプリを実行したままではできないような省電力化を保証することができます。Asahi Linuxマシンで、アイドル時にバッテリーの消耗が激しいという報告がありますが、これは、ほとんどの場合、ユーザ空間の扱いが悪いために、大量のウェイクアップが発生したり、CPUがビジー状態になっていることが原因です。

s2idleは、特別なドライバやサポートを必要としませんが、ドライバでサスペンド/レジュームが動作する (つまり、少なくとも失敗しない) ことが必要です。私たちにとって、これはWiFiチップセットでブロックされており、AppleマシンでS3サスペンド（紛らわしい名前です；ここではs2idleにマップされます）と呼ばれる新しいメカニズムを必要とし、既存のドライバではサポートされておらず、サスペンドプロセスがエラーになる原因になっていました。このドライバと、その他いくつかのマイナーなドライバを実装した結果、s2idleはApple Siliconマシンでも動作するようになりました! linux-asahi-edgeカーネルでは、この機能が有効になっていますので、切り替えれば、デスクトップ環境に魔法のようにサスペンドオプションが現れるはずです。

s2idleは動作しますが、まだ初期段階であり、全てのドライバの問題をデバッグしているわけではありません。以下は、その動作です。

```
    NVMeがシャットダウンされる
    WiFi は S3 モードになります。
    ディスプレイ (DCP) が DPMS に移行 (バックライトと画面が完全にオフ)
    DARTs はパワーゲートし、レジューム時に状態を復元します。
    CPU はシャローアイドルを維持
    いくつかの雑多なデバイス (i2c/spi/etc) の電源が切れる
    電源ボタンまたはリッドオープンでウェイクアップ
```

そして、少なくともこれらのものは、欠落しているか、壊れていることが知られています。

```
    CPUのディープ/パワーオフアイドルなし(通常のランタイムにも影響、SCI交換でブロックされる)
    USB2/3が壊れている (コントローラがリセットされ、レジューム時にデバイスの再接続が必要になる可能性があります。）
    一部のデバイスはまだサスペンドされていません (例: キーボード/トラックパッドはキーストロークをバッファリングするため、壊れる可能性があります)
    代替のウェイクアップソースがない (キーボード/マウス/その他)
```

これらの問題は時間をかけて解決していく予定ですが、皆さんに現状のs2idleを試していただく機会を設けたいと思います 先に述べたように、問題があれば、linux-asahi-edge trackerのissueでご報告ください。

最後に、Apple Silicon Macは、システム全体をより深いスリープ状態にする「真の」S3的なサスペンドモードをサポートしており、これはmacOSがサスペンドに使用しているものです。これはより大きな電力削減をもたらすかもしれませんが、実装がより複雑で、私たちがまだ解決していないいくつかの事柄に依存します。今のところ、s2idleの消費電力を減らすための低いぶら下がり果実がまだあるので、私たちは今後、そちらに焦点を当てることにします。将来的には、「フル」サスペンドが、適切に管理されたs2idleよりも大きなメリットをもたらすことがわかれば、それを実装するかもしれません。

## インストーラのイテレーション

私たちは、新規ユーザー向けの Asahi Linux インストーラにも取り組んでいます。長い話を短くすると、以前のバージョンの問題点（macOSのリサイズ時の安全な制限を計算する問題でリサイズエラーが発生するなど）を多く修正し、また、いくつかのプロンプトの文言をより明確にするために改善しました。また、いくつかのプロンプトの表現を改善し、より分かりやすくしました。

さらに、M2サポートを非エキスパート向けにも推進しました。M1ファミリーの12.3と同様に、M2でも12.4ファームウェア・バージョンをサポートすることを約束します。注意点として、ファームウェアのバージョンというのは、インストーラがAsahi Linuxと一緒にインストールするOSと対になるファームウェアのことを指します。これは、macOSのバージョンとは無関係で、インストーラーは、12.3から13.xまで、現在のすべてのmacOSのバージョンに対応しています。

また、壊れたインストールを復旧する機能と、m1n1 stage 1のバージョンをアップグレードする機能が追加されています。時々、ユーザーはインストール後（ステップ2）の指示に正しく従わず、ブートループに陥ることがあります。これはシステムをシャットダウンして再試行すれば簡単に直りますが、他のこと (別の起動 OS を選択するなど) をするとインストールが変な状態になり、パーティションを消してゼロから再インストールしないと、再試行が難しくなります。インストーラは、「不完全なインストール」を修復する新しい機能を提供します。これは、基本的にプロセスの最後のステップを再実行し、完全な再インストールを必要とせずに、インストール後の指示に再び従うようユーザに促します。

この同じメカニズムは、AppleのmacOSアップグレードプロセスが混乱し、Asahi Linuxのブートポリシーを削除または再作成することでインストールが壊れるという稀なケースからの回復にも有用です。私たちは、このようなことがごくまれに起こることを確認しています（確実に再現する方法を見つけた場合は、ぜひお知らせください！）。この問題が発生した場合の解決方法は簡単なので、ユーザは安心してください。インストーラをもう一度実行し (macOS または recoveryOS からは curl https://alx.sh | sh)、プロンプトが出たら repair オプションを選択するだけです (状況は不完全なインストールと同じです)。

新しい m1n1 アップグレード機能は、m1n1 のステージ 1 バージョンをアップグレードするために使用します。Asahi Linuxのインストールでは、m1n1には2つのステージがあり、第2ステージは常にLinuxパッケージを介してアップグレードされ、新機能を追加するために最も重要です。第1ステージはrecoveryOSからインストールされ、Linuxからアップグレードすることはできず、その仕事は第2ステージをロードすることだけである。それしかしないので、アップグレードする必要はほとんどありません。しかし、稀にバグを修正するのに役立つことがあり、稀にクリーンシャットダウン後にブート失敗が続く問題が確認されています。回避策は簡単ですが（電源ボタンを押しながら起動し、再度Asahiを選択すれば障害は解消します）、新しいm1n1バージョンではこの問題を完全に解決できるはずですので、アップグレードすることをお勧めします。macOSまたはrecoveryOSから通常通りインストーラーを実行（curl https://alx.sh | sh）し、プロンプトが出たらオプションを選択するだけです。朝日インストールとペアになっている recoveryOS から実行すると (つまり、朝日がデフォルトの起動 OS であるときに電源ボタンを押し、オプションを選択する)、通常の強制再起動ステップを回避することも可能です。

最後に、m1n1（プロキシモードのみ）を外付けUSBドライブにインストールするエキスパート専用の実験的な新機能があります。何度も言っているように、Apple のシリコンマシンは USB ブートをサポートしていません。しかし、AppleはUSBドライブからOSブートファイル（カーネル、ブートローダ、ファームウェア）を内蔵NVMeストレージの予約パーティションにコピーすることでこれを偽装しているのです。インストーラは、サードパーティ製OSであってもこの仕組みを利用し、内部ストレージの再パーティションを必要とせず、m1n1の「完全なUSB」インストールを行うことができるようになったのです。インストール完了後に USB ドライブを抜くと、面白いことに、ブートピッカーから他のブート OS を選択するまで、マシンはとにかく m1n1 でコールドブートを続けます (言ったでしょ、USB ブートは偽物だって!)。この USB ドライブは自動的に他の Mac に移植できるわけではありませんが、理論的にはインストーラの「修復インストール」オプションを使えば、新しい Mac で外国の m1n1 USB ドライブを起動可能にできるはずですが、まだテストしていないので、おそらく現時点で同じタイプ/モデルのマシンでない場合は問題があるでしょう。

残念ながら、m1n1 stage 1はUSBホストをサポートしていないので、これで真の「完全な外部」Asahi Linuxインストールはまだできません... 誰かRust USBスタックとxHCIホストコントローラドライバの開発に着手しませんか？）

## エピローグ

いつものように、既存のユーザーに対しては、sudo pacman -Syu でシステムをアップグレードして、再起動するだけで、すべての新機能を手に入れることができます。これは新しいファームウェアのメカニズムへの移行とその他全てを処理します。私たちはみんなのために物事をシンプルに保ちたいのです! 今回は、sudo update-grub を実行して GRUB ブートローダが最新であることを確認し (これは通常のパッケージアップグレードには含まれません)、前述のオプションだが推奨される m1n1 ステージ 1 アップデートについてもメモしておくことをお勧めします。

Linux のインストールを最新の状態に保つよう、皆さんに注意を喚起する良い機会だと思います。macOS Ventura ベータの初期に、アップグレード後に Linux が起動しなくなる問題が見つかりました。何ヶ月も前にパッケージのアップデートで修正しましたが、今日でも Ventura にアップグレードしたユーザが (あるいは最新の 12.x macOS リリースにも同じ問題があります)、その間にアップグレードしなかったために Linux インストールを起動不能にしてしまうということがあります。macOS のアップグレードが Linux を壊滅的に破壊するようなこの種の問題は稀であるべきで、私たちはベータ版をテストして早期に発見するようにしていますが、トラブルを避けるためには、ユーザが OS をアップデートしておくことに依存しています。アップデートしてください! Arch Linux のアップデートも長い間していないと、かなり厄介なことになります。

あ、あ、そうだ、GPUか。そうです。忘れるわけがない! ねぇリナ？来週、GPUの現状をブログで紹介することになったわよ。言い訳するなよ！

![Apple M1でのXonotic](https://asahilinux.org/img/blog/2022/11/xonotic.png)

#### marcan · 2022-11-22

[New in Fedora Asahi Remix](https://asahilinux.org/2024/01/fedora-asahi-new/)の非公式日本語訳です。

---
# Fedora Asahi Remixの新機能

- [前回](https://github.com/asfdrwe/asahi-linux-translations/blob/main/PROGRESS202308.md)

少し前に [Fedora Asahi Remix](https://github.com/asfdrwe/asahi-linux-translations/blob/main/fedora.md) の
**最初**の安定版リリースをリリースできたことを大変誇りに思っています。そして今、これまでのすべてを振り返るときが来ました。
ここ数ヶ月の沈黙は何だったのかと思われたかもしれません。その答えは、今回のリリースにできるだけ多くの機能を詰め込むことに
忙しかったからです。当初の見積もり時間をかなりオーバーしてしまいましたが（よく言われるように、最後の20％の作業に80％の
時間がかかるのです）、新機能に文句を言う人はいないでしょう。これがFedora Asahi Remixのすべての新機能です。
長いのでスナック菓子でも食べながらどうぞ。

## HDMI - ラインナップの完成（ほぼ！）
Fedora Asahi Remixのリリースにより、Pro/Max/Ultraの全種類を含むM1およびM2世代までのAppleのラインアップに新たに追いつきました。
新しいチップと機器のリリースに対応し続けるのは面倒なことで、（すべてのquirksとマジックナンバー付きで）すべてのチップと
プラットフォームを明示的に立ち上げて対応する必要があります。それには、コードの再利用とコンポーザビリティに焦点を当てた
Asahiの高いドライバコード標準は、新しいマシンを立ち上げるプロセスを容易にしてくれます。

しかし、時には大きな変更もあります。M2シリーズの*デスクトップ*機器の対応に時間がかかった理由は、ディスプレイ出力です。
はっきりさせましょう。2022年夏にリリースされたM2ラップトップは数週間後に対応しました。M2 Pro/Maxラップトップの
ディスプレイ対応は、デバイスが使用するDCPファームウェア・バージョン（当初は13.2/13.3、最終的には13.5）への対応を追加する程度で
済みました。これにより、M2 / M2 Pro Mac MinisとM2 Max/Ultra Mac Studios（M2+s）への対応が残りました。iBootが
HDMIを表示しなくなったので、Linuxがロードされる前（例：m1n1、u-boot、grubスクリーン）にデスクトップにディスプレイを
表示させるために、ブートローダー[m1n1](https://github.com/AsahiLinux/m1n1)に*いくつかの*
Display Controller Processor（DCP）コードが必要になりました。しかし、M1とは異なり、M2+sのHDMI出力は
もはやDCPファームウェアによって管理されておらず、特にDCPはもう完全なeDP -> DP2HDMIセットアップを処理しません。
その結果、DCPはdcpextに似た動作をするようになり、より柔軟性が増しました。
例えば、M2 Mac MiniのDCPはUSB-C/Thunderboltポートにルーティングできるようになりました。
これにより、M2 Mac MiniはThunderbolt 4の認証を受けています。しかし、ベアメタルm1n1でこれをすべて行うと、かなり複雑さが増します。

m1n1 の既存の DCP iBoot エンドポイント/プロトコル対応に加えて、AP <=> DCP eDP セットアップおよびルーティング用の
dptx-port エンドポイントと、冗長な syslog メッセージ用のシステム・エンドポイントの 2 つの新しいエンドポイントを
実装する必要があります。さらに、(lp)dptx-phyはdptx-portエンドポイントを介して交換されるメッセージに基づいて
プログラムされなければなりません。最後に、AppleのDeviceTreeとマルチダイの電源管理に一貫性がないため、
若干複雑になったDPコンフィギュレーションをすべて処理します。

ちょっとした副作用として、HDMI出力が14/16インチのMacbook Proでも動作するようになりました！
(物理的なHDMIポート、USB-CからHDMIへのケーブルやアダプターは、すべてDPからHDMIへのコンバーターしかありません）。
DCPドライバのメンテナである[Janne Grunau氏](https://social.treehouse.systems/@janne)は、
[HDMI出力を有効にする](https://github.com/AsahiLinux/m1n1/pull/329)ために、ブートローダやDeviceTreeや
DCPドライバにおいて、精力的に作業を行いました。HDMI出力は、M1 Pro/Maxシリーズのラップトップ以来TODOでした。
M2+のデスクトップHDMI出力サポートは、[Sven Peter氏](https://social.treehouse.systems/@sven)による
リバースエンジニアリングと初期コードに基づいています。特に14/16インチMacbook ProのHDMI出力は、atcphyの既存のDP phy対応を
利用しています。これは基本的に、USBとUSB-CコントローラーなしのUSB-Cポート上のDP-altmodeです。この作業の大部分は、
今後リリースされるType-C DisplayPort出力対応に再利用され、オリジナルのM1を含むすべてのチップをカバーする予定です。
M2デバイスとラップトップでのHDMIサポートには13.5ファームウェアが必要であることに留意してください。
HDMI出力での作業はまだ完了していません:M2+sのデスクトップとラップトップのHDMI出力がs2idleの後に確定的に電源が入りません
（HDMI差し直しで解決できるかもしれません）。4k 60Hzを超える解像度/リフレッシュレートに未対応です。HDMIオーディオ対応を完了し
すべてのデバイス/SoCでテストする必要があります。

![hdmi](https://asahilinux.org/img/blog/2024/01/hdmi.jpg)
後ろの4K HDMIモニターをつないだFedora 39 Asahi Remixを動かす16インチ M1 Max。  
[Source: Hanchin Hsieh, @yuchanns@dvd.chat](https://dvd.chat/notes/9mt5ifiwb2lb00ec)

まだ対応して唯一のプラットフォームはMac Proですがが、しないといけないことはおそらくもうあまり残っていないでしょう。
『MacBook Pro』ではなく『Mac Pro』です。その名前を聞いたことがある人さえほとんどいないでしょう。
Mac Proは圧倒的に人気のないMacモデルであり、もっと緊急にハードウェア対応必要がありました。
M3はどうですか?今年のニュースをお楽しみに...

## GPU - OpenGL ES 3.1に準拠など...
2023年の夏、[Alyssa Rosenzweig氏]https://rosenzweig.io/]のGPUリバースエンジニアリング作業により、OpenGL 2.1から
OpenGL 3.1へ、同様にOpenGL ES 2.0対応がOpenGL ES 3.0へと
[飛躍的に向上](https://rosenzweig.io/blog/opengl3-on-asahi-linux.html)しました。わずか2ヵ月後の2023年8月には
M1ファミリーとM2ファミリーのグラフィックス・ハードウェア向けに、世界で唯一の準拠したOpenGL ES 3.1実装である
OpenGL ES 3.1[準拠](https://rosenzweig.io/blog/first-conformant-m1-gpu-driver.html)ドライバを出荷しました。

次のステップは何でしょうか? [ジオメトリシェーダー](https://learnopengl.com/Advanced-OpenGL/Geometry-Shader)は
OpenGL 3.2 と OpenGL ES 3.2 で導入されました。ジオメトリシェーダーは、1つのプリミティブ（点または三角形など）を
形成する頂点のセットを入力として受け取り、次のシェーダーステージに送る前に、これらの頂点を適切になるよう変換します。
ジオメトリシェーダーが面白いのは、元のプリミティブ（頂点集合）をまったく異なるプリミティブに変換でき、おそらく最初に
与えられたよりも多くの頂点を生成できることです。最新のFedoraリリースではOpenGL 3.3という新しいバージョンを見つけられます。
3.2 と 3.3 は、ジオメトリシェーダーのような高価な機能を追加しています。ジオメトリシェーダーはApple GPUではネイティブに対応
していないため、それらを正しく実装するにはドライバに工夫が必要です。ジオメトリシェーダーがトランスフォームフィードバックや
プリミティブリスタート、間接描画、テッセレーションなどの他の機能と相互作用することによって、これは大きくなります。
私達は規格適合性に含まれる規約としての正しさにこだわります。正しい方法で実装することが最も重要です。それは簡単な方法ではありません。

ジオメトリシェーダーをハードウェアで対応していない場合、どのようにジオメトリシェーダーを実装するのでしょうか？
高レベルでは、ジオメトリシェーダーをコンピュートシェーダ、プリフィックスサム、間接描画などのプリミティブに変換します。
トランスフォームフィードバックは、ジオメトリに変換されたコンピュートシェーダー内で処理されます。間接ジオメトリ描画は
ジオメトリ変換計算シェーダーの間接ディスパッチに変わります。プリミティブリスタートは、コンピュート・プリパスを使用して
GPU 上で展開されます。テッセレーションは（それが解放されたとき）、仕様で要求されているようにジオメトリシェーダーに供給されます。
しかし、これは速いのでしょうか？場合によります。ジオメトリシェーダーは、AMDやNVIDIAのデスクトップ・ハードウェアでさえも
比較的遅いため、アプリケーション開発者はジオメトリー・シェーダーを避けることを推奨します。しかしながら、実際の
アプリケーションでは時折ジオメトリシェーダーを使用することがあり、アプリケーションを壊したくはありません。
規格に適合しなければなりません。だけれども、一般的なGPUでも[遅い](http://www.joshbarczak.com/blog/?p=667)ことが
知られているため、通常はホットスポットにはなりません。十分な速度が必要です。そして実現しました。

その結果、私たちは現在進行中のOpenGL 3.3を、適合性のあるOpenGL ES 3.1と一緒に提供し、より多くのOpenGLアプリケーションとゲームが
Asahi Linuxで動くようになりました。そして、私たちはここで立ち止まるつもりはありません;-)

訳注: ジオメトリシェーダーについての参考文献
- https://ja.wikipedia.org/wiki/%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC#%E3%82%B7%E3%82%A7%E3%83%BC%E3%83%80%E3%83%BC%E3%82%B9%E3%83%86%E3%83%BC%E3%82%B8
- https://soramamenatan.hatenablog.com/entry/2020/10/10/150318
- https://edom18.hateblo.jp/entry/2018/07/11/140455

## Bluetooth - リグレッション修正とM2対応
数回のカーネルマージの後、Logicool Bluetooth マウスが自動的にペアリングされなくなったことに気づいたユーザーがいました。
Linuxではそういうものだと受け入れ、bluetoothctlを使って手動でペアリングを始めたユーザーもいましたが、
Janne Grunnau氏はこの問題を何とかしようと思いました。1つずつパッチを適用しテストする手動のgit解析です。
m1n1の超高速起動とデスクトップまでの[カーネルテストサイクル](https://github.com/asfdrwe/asahi-linux-translations/wiki/%E3%83t%86%E3%82%B6%E3%83%BC%E3%83%96%E3%83%BC%E3%83%88%E3%82%BB%E3%83%83%E3%83%88%E3%82%A2%E3%83%83%E3%83%97%28%E9%96%8B%E7%99%BA%E8%80%85%E5%90%91%E3%81%91%29)を
10秒間有効にしました。Janne氏はkernel v6.4の（Logitechデバイスが使用する）Bluetooth Low Energy (BLE)ベースのペアリング
を後退させる正確なコミットを見つけました。
小さなローペースのLinuxサブシステムは[いいものです](https://social.treehouse.systems/@janne/111133921649343751)。

一方、新しいM2 Pro/Max以降の機器では、新しいBluetooth/Wi-Fiチップを使用しているため、Bluetoothに対応するための微調整も
必要でした。通常の[チップ固有のマジック・ナンバー](https://github.com/AsahiLinux/linux/commit/9713a6347eee6d6b37aee7047b09f650bd8fc2eb)はさておき、AppleがBluetoothファームウェアに暗号署名を始めたことが
判明しました。この問題を解決するのに非常に時間がかかりましたが、修正は[簡単](https://github.com/AsahiLinux/linux/commit/5dc7c9b19468e9ee618c14d9a7c0aa8dbc8a2bbf)でした。

## Wi-Fi - M2/M3のサポートと新機能
Apple MacにはBroadcomのWi-Fiハードウェアが搭載されていますが、Broadcomは（控えめに言っても）オープンソースコミュニティと
密接な関係を持っていません。上流の`brcmfmac`ドライバはありますが、過去数年間は最小限の開発しか行われておらず、
ほとんどのメンテナーは活動しておらず、外部からの貢献もほとんどありませんでした。これまで、このドライバに関する私たちの
作業のほとんどは、より新しいチップのサポートを可能にすることに限られていました（新しいチップのせいで対応しなければならない
新しいファームウェアバージョンやインターフェイスが頻繁に出てくるので、新しいチップ自体が非常に面倒です）。直近では、
最新のアップルM2（およびM3）シリーズ機器で使用されている新しいWi-Fiチップ（BCM4388）に対応しました。
暗号技術的に署名されたファームウェアといくつかの新しいプロトコルへの対応が含まれます。さらに、Sonoma (14.x)に
同梱されている新しいApple Wi-Fi ファームウェアに対応するためのバグも修正しました。また、スリープ中に
Bluetoothがクラッシュする不具合も修正しました（Wi-FiドライバがBluetoothをクラッシュさせるのです。 Broadcomだから...）。

しかし、新しいチップを導入するだけでは、新しいWi-Fi規格のサポート不足から奇妙なバグや電力／スループットの制限に至るまで、
`brcmfmac`ドライバーの残りの問題点を解決することはできません。ありがたいことに、
[Daniel Berlin氏](https://github.com/dberlin)が自らこれらの長年の問題のいくつかを修正し、Asahi Linuxでの
Wi-Fiエクスペリエンスとすべての人向けのWi-Fiエクスペリエンスを向上させることを引き受けてくれました。
最近、Wifi6と6E対応が追加されました。また、より高速なアクセスポイントに接続した場合、スループットが最大約80Mbpsから
最大1200Mbpsに改善されました。最後に、低電力スキャン対応やその他の機能により、Wi-Fiチップの電力使用量が大幅に削減されました。

![speedtest](https://asahilinux.org/img/blog/2024/01/speedtest.png)
M2 MacBook Air 13インチ上でのWi-Fi経由のスピードテスト  
[Source: https://www.speedtest.net/result/15666861184](https://www.speedtest.net/result/15666861184)

## トラックパッド - 正しいサイズの報告
これは簡単でした:トラックパッドのサイズが14インチMacBook Proのサイズとして報告されていた長年のバグを修正しました。
トラックパッド対応が追加された当初、ドライバに単一の寸法セットをハードコーディングすることから始め、とにかく
`大抵は`適切に動作しました。しかし、libinputに微妙な問題を引き起こすので、最終的にファームウェアから直接
トラックパッドの寸法を取得する対応を実装することになりました。これで、現在も将来も、すべてのトラックパッドが
正しいサイズを報告するようになりました。

## タッチバー
Appleは過去入力/HIDに関して疑問のある決断をしてきました(🦋🔑 /🪄🐭)。13インチMacbook Proユーザーのみなさんは、
ファンクション列が真っ黒でブロックのように反応しないことに強い感情を抱いていたことでしょう。
『キーボード・バックライト・ドライバ』で人気の [ChaosPrincess氏](https://github.com/WhatAmISupposedToPutHere)が
Apple Z2 タッチスクリーン・ドライバによってMac に新たな光を与えてくれます。T2マシンでは、T2自体がタッチバーに対応し、
通常のキーボード機能列をエミュレートすることができましたが、Apple Siliconデバイスではそのような贅沢はできません。
タッチバーを点灯させるために、ChaosPrincess氏はタッチスクリーン・コントローラとディスプレイ出力コントローラ（
これはメイン・ディスプレイとは全く別のディスプレイ・コントローラです...）をリバースエンジニアリングし、
すべてのハードウェアを一緒に駆動するためのユーザーランド・デーモンを*書かなければ*なりませんでした
余談ですが、タッチスクリーン・コントローラとディスプレイ・コントローラは、ある種のモバイルiDevicesに
搭載されているのと同じIPブロックです。なので、もし誰かがcheckra1nを使ってiPhoneにフルLinuxを入れたいのなら、
この成果の一部は役立ちます;）

Rustユーザーランド・タッチバー・デーモンは`[tiny-dfr](https://github.com/WhatAmISupposedToPutHere/tiny-dfr)`です。
タッチバー・エコシステムとサードパーティー・アプリの統合を専門に行う開発チームがないのは明らかですが、`tiny-dfr`は
最も重要な機能を備えています：F{n}行とメディア・コントロール・キー（明るさ、音量、バックライト、再生など）の表示です。
これらのキーレイヤーの正確な内容は設定可能で、`/usr/share/tiny-dfr/config.toml` にある設定テンプレートを自由に見てください。
現在Fedoraにパッケージされているバージョンは固定キーレイアウトしかサポートしていませんが、設定可能な`dnf upgrade`が
間もなくリリースされる予定です。小さいですが、非常に強力です。

## NVRAM
パーティションを切り替えた後、Bluetoothのペアリングに失敗したり、デフォルト以外のブートパーティションを選択するために
電源ボタンを押し続けるのが嫌になったりしたことがあるかもしれません。ブートピッカーはどのようにしてMacを特定のボリュームで
起動させるのでしょうか？NORフラッシュの内部には不揮発性ランダムアクセスメモリ（NVRAM）セクションがあり、
様々なブート関連の環境変数が格納されています。ボリュームを選択すると、ブートピッカーはNVRAMのブートパーティションキーを
選択されたボリュームとして設定し、Macは次回の起動時にそこからブートオプションを取得します。NVRAMには、Bluetoothの
ペアリングキーやWiFiの設定も保存されるので、リカバリーモードでも入力デバイスやネットワークがシームレスに接続されます！
ChaosPrincess氏は、Apple Silicon機器に搭載されているNVRAMチップを操作する[ツール集](https://github.com/WhatAmISupposedToPutHere/asahi-nvram/)を開発しました。
NVRAMツール集（`dnf install asahi-nvram`）は、LinuxとmacOSを頻繁に切り替える人には特に興味深いものでしょう。

- `asahi-bless`： デフォルトと次のブートOSを選択可能に。選択したOSを『blesses(祝福)』
- `asahi-btsync`： Bluetoothのペアリングキーを取り出し、bluezコンフィグを作成
- `asahi-wifisync`： WiFiパスワードを抽出し、iwdコンフィグを作成
- `asahi-nvram`： nvramコンテンツへの生アクセス。これには注意。いくつかのキーに触れると、DFU Cityへの切符を手に入れることに

NVRAMをいじることは危険であり、このツールスイートはまだアクティブに開発中ですがが、`asahi-bless`は実戦テスト済みで
非常に安全に使え、Macのブートボリュームを変更するのに非常に便利です。
[Davide Cavalca氏](https://github.com/davide125)は`asahi-bless`のGUIフロントエンド（WIP）である
[Startup Disk](https://gitlab.gnome.org/davide125/startup-disk)に取り組んでおり、macOSのようなきれいな
ブートピッカーインターフェースを提供してくれます。さらに、`asahi-btsync`はBluetoothのクロスOSペアリング問題を
解決するのに非常に便利です。将来的には、BluetoothとWi-Fiの同期がシームレスに双方向で実行されるように、NVRAMが
システムの他の部分とより緊密に統合されることを期待しています。

繰り返しますが、ブート・コンポーネントとディスク・コンポーネントは常に注意深く扱われるべきですが、Apple Siliconの強固な
[ブート・セキュリティ・プラットフォーム設計](https://github.com/asfdrwe/asahi-linux-translations/wiki/Apple-Silicon%E3%81%AE%E7%B4%B9%E4%BB%8B)のおかげで、`asahi-nvram`を使ってシステムを壊そうと頑張ったとしても、
起こりうる絶対的な最悪のケースは、機器が起動不能になり、別の機器で*リセット*（DFU）する必要があるということです。
取り返しのつかない永久的な文鎮化は決して起こりません。

## カメラ
予言:優れたDSPがあれば、アップルは数十年前のiPhoneセンサーをピカピカの新型Macに搭載することができます。
カメラブロック全体（DisplayPortに接続されたCMOSセンサー、緑色のセキュリティLED、arm64コプロセッサから、
生のセンサー出力をフィルタリングするための専用の自社製画像DSPブロックまで）は、内部的に『Image Signal Processor：』
（ISP）と総称されています。これは奇妙で、明らかに最後の1つ（DSPブロック）だけが "ISP "の説明に当てはまるのに、
なぜカメラブロック全体が "ISP "と呼ばれているのでしょうか？この名称は実はかなり理解しやすいです。Appleは、
10年以上にわたってソニーからイメージセンサーを忠実にアウトソーシングしてきただけでなく、キャプチャー作業の多くを
ハードウェア（センサー）からソフトウェア（後処理）に委ねてきました。言い換えれば、センサー（DeviceTreeでは
720pの2020 M1 MacBook Proは[S5l8960x](https://theapplewiki.com/wiki/S5L8960)で、iPhone 5Sと
しても知られています）をケチって、後処理に頼っています。カメラの正体は、たまたまセンサーを搭載したDSPブロック
なのです。しかし、Appleの画像DSPがいかに優れているか（Appleはカメラが得意なのだから仕方がないのだが...）、
読者は知らなかったに違いないと思っています。

作業をハードウェアからソフトウェアに移すことで、複雑さがドライバに移ります。
[12MB](https://github.com/asfdrwe/asahi-linux-translations/wiki/Apple-Silicon%E3%81%AE%E7%B4%B9%E4%BB%8B#%E3%83%95%E3%82%A1%E3%83%BC%E3%83%A0%E3%82%A6%E3%82%A7%E3%82%A2%E3%81%AE%E6%A6%82%E8%A6%81)の
ISP RTOSファームウェアブロブと友達になり、3桁に相当するデバイス固有のDSPコマンドと、それらが呼び出されるフィルターグラフを
苦労してリバースエンジニアリングすれば、Appleの世界トップクラスの画像DSPを利用して、Linuxでも同じように優れた
キャプチャ出力を得ることができます。短くまとめると、[5K行以上](https://github.com/AsahiLinux/linux/tree/bits/240-isp)の
カーネルコードと120のオペコード、47のセンサー（全部は使わないが）、18のパワードメイン（史上最悪のシーケンス）、7つの割り込み
チャンネル、2グロスのバッファハック、そして1つの[テディベア](https://vt.social/@lina/111138275387398507)、
緑色のLEDが光ってカメラが回っていることを知らせてくれて、ViCoのミーティングに行けるようになります。
[Eileen氏](https://github.com/eiln)、ありがとうございました。

もし誰かがLinuxを特定のハンドヘルドiDevicesに移植することになり、マルチメディア周辺機器を気にする余裕があれば、ISPドライバが
カバーしてくれます。AppleはAppleのエコシステム全体で同じカメラ・ドライバを使用しているため、これは単なるウェブカメラかも
しれませんが、私達のドライバは、iPhone 15 Maxに搭載されているSony IMX913までの互換性のあるセンサーをリストアップしています。
ISPドライバは、そちら側で少し追加作業をするだけで、最新かつ最高のiPhoneカメラを駆動できるはずです
（ストロボ／フラッシュの処理、フロント／リアの区別、複数のリアチャンネルの同期を残っています:ヒント:チャンネルの
初期化にはビットマスクを使いましょう、 ボイラープレートがあります)。

P.S. おそらく現存するLinuxデスクトップで唯一、縦型（FaceTime）ビデオに対応していて、その結果、面白いユーザー空間の
バグがいくつか見つかりました。まず、いくつかのアプリはデフォルトで最も高い垂直解像度になるため、垂直ビデオが提供された場合、
予期しない動作になります。さらに、ウェブカメラアプリに緑色の斜線がある場合は、解像度をチェックしてください。
アプリがデフォルトで垂直モードに設定されている可能性があり、いくつかのアプリは、ドライバが宣伝する（ISPハードウェアが動作する）
64バイトのストライドを尊重していないことがわかりました。スキップされたデータはYUVゼロに初期化され、RGBイコールグリーンに
変換されます。上流第一のポリシーに従って、アプリを自由に報告してください (GNOME Cheese には現在問題があることが知られています)。

## スピーカー
Appleはオーディオの音質にこだわります。*実際に*オーディオの音質に気を付けています。macOSはMacに1組の
ステレオスピーカーが搭載されていると伝えてきますが、実際にはMacに6つものスピーカーが搭載されている可能性があります。
例えば、14インチと16インチのMacBook Proには、*それぞれの*チャンネルに低音と中音用の2つのウーファーと高音用のツイーターがあり、
他のほとんどのラップトップよりも最新のHiFiスピーカーに近い配置になっています。

それでも、物理法則によって小さなスピーカーがどれだけ良い音を出せるかに上限が設けられます。Appleは、この限界を克服するために
DSP技術を駆使し、macOSのユーザースペース・オーディオスタック用のプラグインとして実装しています。これらのプラグインは
Linuxと互換性がないため、ひどいスピーカー音質で我慢するか、Appleのプラグイン・チェインを独自に構築するしかありません。
私たちは、これを制限と考えるのではなく、Asahi Linuxの実行時にApple Silicon Macの音を*良く*するという高い目標を
設定するチャンスだと考えました。成功したと思っています。

大音量でダイナミックな音を出すために最も重要なのはパワーです。マイクロスピーカーを許容できる音量でまともな音を出すには、
*かなりハードに*駆動する必要があります。これは、マイクロスピーカーが非常にデリケートであるという事実によって複雑になっており、
ほんの少しでも大きなパワーをほんの少しでも長い時間押し込むと、永久的な損傷を与えるのに十分なのです。
[speakersafetyd](https://github.com/AsahiLinux/speakersafetyd)は、世界初（そして唯一）のフリー・オープンソース・
ソフトウェアによるスピーカー保護アルゴリズムの実装です。各スピーカーを駆動するアンプICは、スピーカーを通過する電圧と
電流をOSに通信します。speakersafetydは、この情報と、マシン内の各スピーカーについて既知のいくつかの電気的および
熱的パラメータを使用して、各スピーカーの温度を概算し、追跡します。speakersafetydとその背後にあるカーネルのメカニズムは
信じられないほど堅牢で、安全チェーンのどこかが何らかの理由で失敗した場合、カーネルはメルトダウンを防ぐために
フェールセーフになり、スピーカーへのすべての電力をカットします。

安全性？チェックしましょう！さあ、楽しみましょう。測定によると、Apple Silicon Macのスピーカーは約200Hzで底をついています。
これはおかしいです...macOSの下では、アップルは筐体に本格的なサブウーファーを詰め込んでいるようです！どうやってこうしているの
でしょうか？結論から言うと、人間の脳は基本的にドロドロしています。脳は、倍音を弄ることで実際には存在しない周波数が
聞こえるように騙すことができ、アップルがMacBookの低音域のレスポンスを拡張するために行っているのは、まさにこれなのです。
このスピーカーが再生*できる*周波数特性をフラットにする標準的なEQフィルター上で、
[James Calligeros氏](https://github.com/chadmed/)は、[Bankstown](https://github.com/chadmed/bankstown)と
いう低音エクステンダーを開発しました!

最終的に、PipewireとWireplumberの開発者と協力して、カスタムEQとDSPコンフィギュレーションを自動的にロードし
のアプリケーションから 『生』出力を隠すソリューションを開発しました。この作業は非常に重要でした。デフォルトの
デスクトップ体験が、不具合やハックの脆弱なコレクションになることは避けたかったからです。ログインするだけで、
スピーカーは意図したとおりに動作します！手作業は必要ありません。設計し上流に提供したメカニズムは一般的なもので、
同様の複雑な処理を必要とするあらゆるデバイスの駆動に使用できます。

これは氷山の一角に過ぎません。スピーカー対応までの道のりをより詳しく紹介する予定ですので、ご期待ください！

# 作業中　ここまで(2024/1/13)

## Energy-Aware Scheduling(エネルギーを考慮したスケジューリング)
Apple Siliconは、電力効率では文句なしのチャンピオンです。macOSを搭載したMacBook Airのバッテリー駆動時間が12～15時間に
なることも珍しくありません。Appleは、ARM64コアから信じられないような数値を引き出すために、秘伝のソースを使った魔法でも
使っているのでしょうか？そうではありません。Linuxがかなり以前から可能であったにもかかわらず、これまで誰も利用しなかった
トリックを使っています。

ほとんどのx86マルチコアプロセッサは、同一のCPUコアをn回コピーペーストして構成されています。対称的でコアに仕事を公平に配分するのは
比較的簡単です。Apple Siliconは無論パフォーマンス重視のPコアと効率重視のEコアからなるヘテロジニアスシステムです。
Apple Silicon上でタスクをスケジューリングしてみましょう。タスクAには10個の『パフォーマンス』が必要だと知らされました
（実際の指標は重要ではありません）。DeviceTreeを調べると、パフォーマンスコアは1.2GHzで10のパフォーマンスを
提供できるのに対し、効率コアは最大動作ポイントである2.4GHzでしかそれを発揮できないことがわかります。
そのため、スケジューラはタスクAをパフォーマンスコアに配置します。パフォーマンスコアは低い動作ポイントで
性能要件を満たすことができるからです。

しかし、我々は重大なミスを犯しました。Pコアは1.2GHzで3.7Wを消費するのに対し、Eコアは2.4GHzで1.6Wしか消費しません
（これが効率という名前の由来です）。スケジューラーはEコアにタスクを配置すべきでした！Energy-Aware Schedulingは、
スケジューラに各コアが与えられた動作ポイントでどれだけの電力を消費するかを伝えることで、エネルギー消費を最小限に
抑えるより良いスケジューリング選択を可能にします。この機能は、スケジューラがタスクの性能要件について正確な予測を
しているときには効果的ですが、それができないときにはどうなるでしょうか？

スピーカー対応に取り組んでいたとき、PipewireとWireplumberが常にPコアにミススケジューリングされていることがわかりました。
デフォルトでは、カーネルはリアルタイムのスレッドに対して、他の何よりも『遅れない』とを優先するため、
オーディオ処理は、そのリアルタイムの性質上、常にフルパフォーマンスが与えられていました。計算してみたところ、
DSPコードを実行するのにフルパフォーマンスに近い性能は必要ないことがわかりました。この問題を解決するために、Pipewireと
Wireplumberに、アプリケーションの性能要件を一定の範囲に固定するスケジューラ機能であるUtilization Clamping
(訳注:(解説文書)[https://docs.kernel.org/scheduler/sched-util-clamp.html])を使う機能を与えました。
PipewireとWireplumberの最大性能を極端に低く設定し、スケジューラが*最低*動作時に効率コアへ制限するようにした。
どちらも*完璧に*機能し、ユーザーのバッテリー寿命を大幅に節約できます！この素晴らしい機能はあまり活用されていないため、
数週間前に私たちが要求するまで、標準のFedoraカーネルでは有効化されていませんでした（CONFIG_UCLAMP_TASK）。
Fedoraでの有効化がより広範な採用につながることを願っています。エネルギー消費の削減だけではないです:この機能は、
カーネルのスケジューラがデフォルトで適切な決定をしない場合に、パフォーマンスを最適化するために別の方向にも使用することができ、
これはゲームやその他のCPU/GPU混在ワークロードで重要な意味を持ちます。

EASとUtilization Clampingを組み合わせることで、15インチM2 MacBook Airのバッテリー駆動時間は、デスクトップに
座っているだけで約6時間だったものが、1080p30のYouTubeで約8～10時間、デスクトップで12～15時間、スクリーンオフの
アイドルタイムで25～28時間という驚異的な長さになりました。、バッテリー駆動時間をさらに延ばすために、まだまだ
たくさんの裏技を用意しています。ご期待ください！

## ユーザースペースとディストリビューション
### `kernel-16k` - Fedora に群がる
荒々しいA-for-Alpha Arch Linux ARM (ALARM)の時代には、Asahiカーネルパッケージには2つのフレーバーがありました：
Apple SiliconハードウェアがLinuxを実行するために必要な機能を有効にしたベースラインフレーバーと、
より実験的な作業を含む『edge』フレーバーです。『edge』フレーバーは手動で`pacman -S linux-asahi-edge`を
インストールすることで、モルモットになることを選択した人もいました。-edgeパッケージは、DCPバックライト/輝度コントロール、
システムワイドスリープ、GPUドライバのような魅力的なオファーを予告していたからです。面白いことに、『edge』は
ずっと同じgitブランチで、カーネル設定によっていくつかの危険なドライバを無効にしていただけでした。しかし、ALARMの
終わりには、これらのドライバが成熟し、十分にテストされていたため、-edgeをインストールするようにみんなに勧めていました。
実際には、Xorg+ALARMは、GPUドライバがインストールされていない場合、カーソルが数ピクセル上に浮くバグが残っています
（-edgeをインストールすると魔法のように消えます）。これらのedgeと非degeの不一致は、開発者とユーザーを苦しめるだけでした...

このディストリビューション移行の機会を利用して（fedoraに群がる！）、`-edge`を完全に削除しました。edgeフレーバーで
提供されていたすべてのコードは安定化され、メインのカーネルフレーバーとしてリリースされました。
[Neal Gompa氏](https://github.com/Conan-Kudo)によってメンテナンスされている統一Linuxカーネルパッケージは、
単一の`kernel-16k`パッケージの下で以前持っていたすべてを可能にします！さらに、`kernel-16k`フレーバーの
フレームワークをFedora kernelパッケージに寄贈しており、カーネル作業内容が上流に提供されれば、将来有効になります。

カーネルからユーザーランド、そしてディストリビューションへへ...

![fedora](https://asahilinux.org/img/blog/2024/01/fedora.png)
Fedora 39 Asahi Remix KDE System Information

### Widevine - AsahiでNetflixとSpotifyを楽しむ
NetflixやSpotifyが動かないなら、デスクトップに何の意味があるのでしょう？メディア配信サービスでは、保護された
プレミアム・コンテンツを配信するためにデジタル著作権管理（DRM）システムを必要とすることが多く、 FOS Linuxでは、
期待通りにスムーズに進みます。AppleはNetflixと直接協力し、『FairPlay』と呼ばれるカスタムDRMソリューションを
導入していますが、FairPlayはLinux上には存在せず、ハードウェアの制限により、修正されていないmacOSのインストールに
限られています。それでも、多くの人がSpotifyを必要としています。WidevineはGoogle独自の『クロスプラットフォーム』
コンテンツ保護ソリューションなので、Widevine blobをインストールするだけで、NetflixとSpotifyは動作するはずです。
残念ながら、グーグルが公式に対応していないプラットフォームにWidevineを単純に『インストール』することはできません。

ごく最近、Widevineを搭載したARM64 Linuxっぽいプラットフォームが登場しました。残念ながら、ChromeOSは『Linuxっぽい』
だけであり、ChromeOSのバイナリは、標準的なARM64デスクトップLinux上でそのままでは実行できません。Widevineのブロブは、
メモリページのアライメントの問題とglibcの非互換性の両方を回避するために、手作業でパッチを当てなければなりませんでした。
恐ろしいハックであるにもかかわらず、
[信頼できるユーザーフレンドリーなインストーラー](https://github.com/AsahiLinux/widevine-installer)にパッケージ化
することができました。全プロセスはmeme形式で要約することができますが、
[David Buchanan氏](https://github.com/DavidBuchanan314/)のオリジナルの記事も[ここ](https://www.da.vidbuchanan.co.uk/blog/netflix-on-asahi.html)でチェックできます。NetflixとSpotifyをすべての人に。

![widevine](https://asahilinux.org/img/blog/2024/01/widevine.jpg)
You wouldn't pay for 4K Netflix and...  
[Source: David Buchanan, The Quest for Netflix on Asahi Linux](https://www.da.vidbuchanan.co.uk/blog/netflix-on-asahi.html)

### OpenH264 - 弁護士はこのH.264のトリックが好き
関連するニュースとして、ある種の動画圧縮規格（例えばH.264/H.265）は激しく擁護される特許に悩まされているため、Fedoraは
合法的にそれらを提供することができません。marcan氏はAsahiのシームレスなアウトオブボックスエクスペリエンスに誇りを持っており、
H.264はビデオのJPEGまたは『フォールバックコーデック』であるため、アウトオブボックスのH.264サポートは必須でした。
Fedoraは、シスコのOpenH264経由でH.264に対応しています。これは、コンパイル済みのバイナリとして配布される
オープンソースのH.264実装です。シスコシステムズは、バイナリが彼らのリポジトリから直接ダウンロードされインストールされる限り、
適切なライセンス使用料をカバーします。従来、これは、ユーザーがFedora Linuxをインストールした後、手動でOpenH264を
インストールしなければならなかったことを意味します。

Asahi Linuxインストーラーは、とにかくインターネットから直接インストールするので、インストールプロセスの一部として、Ciscoの
サーバーから直接これらのコーデックパッケージを事前にダウンロードする対応を追加しました。その結果、Fedora Asahi Remixは、
箱から出してすぐにH.264を搭載し、完全に弁護士によって承認された最初のFedoraスピンとなりました。

他の特許コーデックを自己責任で使用したいユーザーは、RPM Fusionの`libavcodec-freeworld`パッケージなど、サードパーティーの
リポジトリからインストールすることができます。
[RPM Fusion](https://docs.fedoraproject.org/en-US/quick-docs/rpmfusion-setup/)はFedoraやAsahi Linuxとは関係ありません。

## 進行中...
さて、次は私たちが用意しているいくつかのトリックです。これらは2024年に届くかもしれないし、届かないかもしれません。

### ハードウェアビデオデコード
OpenH264は定義上H.264をデコードできるはずですが、H.265/HEVCをデコードすることはできません。H.265/HEVCは基本的に
H.264をライセンス部分も含めて強化したものです。OpenH264はまたより高速になる可能性があります：
SIMDコードはほとんどなく、ARM64 SIMDはさらに少ない（Janne氏なら知っているでしょう...）。
スピーカー対応がリリースされたことで、高速、高品質、省電力なビデオデコードの必要性が高まっています。
Mシリーズコアのソフトウェアデコードは、いくつかのハードウェアデコーダーよりも高速ですが、ラップトップのバッテリーが
放出する熱に変換される速度がmacOSよりも明らかに速いと報告するユーザーもいます。少なくともmacOSの効率に匹敵する数字を
出したいと考えています。

Apple Video Decoderは、ビデオのデコードに特化したカスタム命令セットによって駆動されるマルチフォーマット・
プログラマブル・ハードウェアです。AVDは、その複雑さにもかかわらず、奇妙なことに、低レベルのデコード・ロジックを処理す
るファームウェアがないので、文字通りすべての部分を自分たちでREしなければなりません（副作用として、
ドライバ／ファームウェア・スタック全体が完全にオープンソースになります）。ビデオコーデック規格は880ページのマニュアルの
化け物であり、とても簡単な努力ではありません。Eileen氏の[avd repo](https://github.com/eiln/avd)は現在、
H.264 High Profile、High 4:2:2 Profile、High 10 Profile、High 10 4:2:2 Profileを誇っており、
機能だけならopenh264に勝ります。HEVCは規格準拠に近づいています。VP9の概念実証が存在します。

![avd](https://asahilinux.org/img/blog/2024/01/avd.png)
VP9でエンコードされたマトリックスの銃撃シーンをm1n1プロキシ経由でAVDデコード   
[Source: https://github.com/eiln/avd](https://github.com/eiln/avd)

もう一つのハードルは、Linuxのビデオ・ハードウェア・アクセラレーションAPIです。現在のオプションでは、デコード・ロジックの
大部分を処理するファームウェアを持たないビデオ・デコーダ・ドライバの要求をすべて処理することはまだできません。
V4L2？VA-API？Vulkan？2024年に答えがでるでしょう。

### 『Steamを実行できますか？』
Apple Siliconデバイスは16Kページを使用していますが、それ以外の（x86）世界は4Kで動作しています。
Apple Siliconを4Kカーネルで動かすことは技術的には可能ですが、上流で侵襲的で議論の余地のある変更をいくつも加える必要があり、
性能にも大きな影響が出ます。より良いアプローチは、ホストをネイティブの16Kカーネルで実行し、問題のあるワークロードには
VMで4Kカーネルを使用することでしょう。

しかし、VM内での3D性能はあまり良くないです。そうでしょうか？
[XDC 2022](https://www.youtube.com/watch?v=9sFP_yddLLQ)でRob Clark氏は『DRM native context』と呼ばれる技術により、
VM内の3Dアクセラレーションでネイティブに近いパフォーマンスを達成できることを実証しました。問題は、『DRM native context』を
Asahi Linuxに移植できるかどうかで、DRMドライバごとに個別に実装する必要があります。これは非常に重要なプロジェクトであり、
複数のコンポーネントの変更を伴iいます。Mesaとvirglrendererの両方で、asahi/agxドライバ用のfreedreno上にRob Clark氏
の仕事と同等のものを実装する必要があります。また、virtio-gpu+rutabaga に対応し、オーディオはゲームにとって非常に
重要な機能なのでvirtio-sndにも対応するために、libkrun (VM の起動と駆動に使われる軽量 VMM) を拡張する必要があります;-）

![VM](https://asahilinux.org/img/blog/2024/01/portal.png)
約60FPSでAsahi内のVMで実行しているPortal  
[Source: Sergio Lopez, @slp@fosstodon.org](https://fosstodon.org/@slp/111031658946870639)

この記事を書いている時点では、[virglrenderer](https://gitlab.freedesktop.org/virgl/virglrenderer/-/merge_requests/1274)
のMRと[libkrun](https://github.com/containers/libkrun/pull/144)のPRが必要な部分を追加しています。また、
下流パッチを使って試してみるための手順が書かれた[ブログポスト](https://sinrega.org/2023-10-06-using-microvms-for-gaming-on-fedora-asahi/)もあります。
[Sergio Lopez氏](https://fosstodon.org/@slp)は、今後数ヶ月のうちに、すべてを上流に統合し、Fedora Asahiですぐに使えるように提供したいと考えています。

### DP AltモードとThunderbolt
```
17:30 <sven>: you can also mention that dp altmode and thunderbolt is in progress and should come sometime in 2024
```

## いますぐインストール！
私たちが取り組んできたことをいくつも楽しんでいただけたなら幸いです。
[Fedora Asahi Remix](https://github.com/asfdrwe/asahi-linux-translations/blob/main/fedora.md)のアナウンスページや、新しい[ユーザーガイド](https://docs.fedoraproject.org/ja/fedora-asahi-remix/)を忘れずにご覧ください。
ご自分の目で確かめてください。いますぐインストール:

```
curl https://alx.sh | sh
```

#### Eileen Yoon氏 2024-01-12

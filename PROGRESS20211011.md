[Progress Report: October-November 2021](https://asahilinux.org/2021/12/progress-report-oct-nov-2021/)の非公式日本語訳です。

訳注: 
- Githubのmarkdownで使えないiframeでのtwitterへの埋め込みをリンクに置き換え
- Githubのmarkdownで使えない表のセルの結合や色があるので表は画像にして貼り付け

---
# 進歩報告:2021年10月11月
- [前回](https://github.com/asfdrwe/asahi-linux-translations/blob/main/PROGRESS202109.md)

おっと、忙しさにかまけて1ヶ月飛ばしてしまいました。この2ヶ月間カーネルランドでは様々なことがありました。10月と11月を合わせた進捗レポートをお楽しみください！

## M1 Pro/Maxが家族の一員に
10月末にAppleは次世代Apple Siliconを発表しました。M1 ProとM1 Maxです。私たちはこの新しい機器への対応に取り掛かり、
[数日の作業後](https://www.youtube.com/playlist?list=PL68XxS4_ek4bo7umPx1AuhGHAUh-lVUGs)、M1機と同等の機能に
引き上げることができました! 今後これらの機器も前世代と同様に対応していく予定です。

[埋め込みツイート](https://twitter.com/marcan42/status/1458473546225577987)
(glxgearsはソフトウェアレンダリングで60FPS以上で動作する機能はないが動作)

アップルが新しいチップで何をしたのか覗いてみると面白いです。オリジナルのM1（コードネーム『Tonga』、SoC名『T8103』）は、Appleの既存の命名規則に従うなら
A14Xと呼ぶのがより適切だったでしょう。実際、これはA14 iPhone SoC（T8101）のタブレット版なのです。Macに適したチップを作るためにAppleはいくつかの
重要な機能（Thunderbolt対応など）を追加しましたが、それ以外は旧iPhone中心のアーキテクチャをほぼそのまま残しています。

これはM1が出荷された機器クラスではうまく機能しましたが、A14クラスではより大きなSoCにスケールアップする際の限界に直面しました。これはAppleの先見性のなさに
よるものではなく、古いSoCとの後方互換性を可能な限り維持しようと努めているためです。つまり、A14の設計要素は、ずっと古いiPhoneのチップにまでさかのぼることができ、
16GBのRAMや16以上のコアがモバイルデバイスにとって全く馬鹿げていると思われていた時代に由来しています。

M1 Pro/Max（コードネーム『Jade』、SoC名『T6000/T6001』）で、Appleは将来のチップでスケールアップする準備としてM1アーキテクチャに繰り返し取り組みました。
コアコンポーネントはそのままに（M1 Pro/MaxはM1と同じコンポーネントの大半を搭載し同等のCPUコアを含む）、M1が限界を迎えていた2つの重要な領域、割り込み
コントローラと物理アドレス空間サイズ（IOMMUの変更が必要）で後方互換性を破りました。

割り込みコントローラはApple Interrupt Controller 2となり、AIC1を使用していたiPhone用SoCとの長年の後方互換性が破られました。AIC1は
最大32個のCPUコア（コプロセッサを含むので実際には『通常の』コアはより少ない）に対応し、M1では使われなくなったレガシーIPI機能に対応する、明らかにシンプルな
コントローラでした。AIC2ではこのレガシーな機能のいくつかが削除されCPU親和性対応(訳注: CPU affinity support)が完全に削除されました。代わりに、
自動的なヒューリスティックが存在します。ヒューリスティックがどのCPUに割り込みを送るかを選択し、CPU自身やそのCPUの状態（アイドル、アクティブ、
割り込み有効など）に基づく設定決定によってヒューリスティックが影響を受けます。
これによりAIC2は必要なコア数まで無限に拡張できるでしょう。なぜなら、割り込みコントローラ自身が個々のCPUコアを選択しなければならない部分がなくなったからです。

AIC2での作業中に私たちは興味深い機能を発見しました。macOSはIRQ制御レジスタを1セットしか使用しませんが、実際には2セット目が存在し、未使用でどのハードウェアにも
接続されていないようでした。つつきまわしてみると、これは割り込みコントローラーの動作する後半部分であり、ここから送られた割り込みは以前は常に『0』だった
イベント番号のフィールドにmagic『1』を付けてポップアップされることがわかりました。そう、これはよく噂されるマルチダイ対応です。M1 MaxのSoCは、どう見ても、
マルチダイモジュールで2個搭載した製品に対応するように設計されています。まだそのような製品は存在しませんが、先行してAIC2ドライバにマルチダイ対応を
導入しています。運良く致命的なバグがなければ、新しい2ダイの機器がリリースされたときにLinuxがそのまま動くということになるはずです

CPUコアの物理アドレス空間は、36ビット（64GiB）から42ビット（4TiB）に増加しました。RAM領域はアドレス空間の上位32GiBから上位3TiBに移動しました。
つまり、旧M1チップはアーキテクチャ上最大32GiBのRAMに制限されていたが、M1 Pro/Max版では少なくとも1TiBまたは3TiBまで対応（power-of-twoを維持するかに依存）が
可能になったということになります。これは、チップが実際にサポートするメモリ量ではなく、基盤となるアーキテクチャが互換性のない変更なしにどれだけ拡張できるかを示して
いることに注意してください。

この物理アドレス空間の増加に対応するためには、DART（ほとんどのペリフェラル用）やSART（NVMeコントローラー用）など、システム内のIOMMUに変更が必要でした。
面白いことに、Linuxでこの対応を実装しているときに、Linux の ARM SMMU 対応コード内に52ビットアドレス対応が導入されて以来ずっと存在し続けていたバグに
遭遇しました。これは256TiB以上のRAMを持つシステムを破るものであり、なぜ誰も気づかなかったのでしょう？いずれにせよ、Linux は現在最大 4 PiB の
RAM を持つ標準 ARM システムに正しく対応しています ;-) 

M1 Pro/Maxへの導入の残りは順風満帆でした。ブートローダ m1n1 と新しいDeviceTreeへのいくつかの調整だけで、Linux 自体への変更は必要ありませんでした。
これはM1の開発を始めた当初から、Appleが不必要に互換性を壊さず、SoCごとの細かな処理をLinuxではなくm1n1で維持できると賭けていたことです。
これまでのところこれは事実で、DARTsやAICが再び変更されることはしばらくはないと予想しています。これにより、古いカーネルでも新しいハードウェアやSoCで
起動できるようになります（例えば、ディストリビューションのインストーラーを実行後に完全対応のカーネルに更新するために十分な程度）。これは
このスタイルの組み込み ARM システムではほとんど前例がありません。

新しい M1 Pro/Max MacBook の新機能には、HDMI ポートやより複雑なスピーカー構成やSD カードリーダーが含まれます。HDMIポートは、外部ディスプレイに
どの機器でも全く対応していないためまだ対応していませんが（もちろんMac MiniのHDMIポートを除く）、将来的には一般的な外部ディスプレイへの対応とともに
提供されるでしょう。SDカードリーダーは、動作させるためにいくつか修正が必要でしたが、すでに上流に提出済みで、素晴らしい動作をしています。
最後に音声対応は現在進行中のオーディオドライバの作業の一部として追加される予定です。

皆さん今何を考えていますか？ノッチ（や丸みを帯びた角）について、今のところノッチへの明示的な対応はありませんが、上のツイートにあるように、KDE Plasmaの
パネルをmacOSのレイアウトに合わせて設定することは難しくありませんし、ノッチをうまく利用することも可能です！とはいえ、私たちの計画では、最初は適切な
ディスプレイドライバでユーザー空間に提示される画面解像度からノッチを除外し、既存のノッチ非対応デスクトップ環境が何の変更もなく動作するようにする予定です。
将来的には、デスクトップでどのように対応すべきかを検討しながら、ノッチ対応コンポジターによって選択可能となる追加のノッチフル解像度を有効にする予定です。
面白いことに、ノッチとコーナーエッジのピクセルはハードウェアで適切にアンチエイリアス処理されています。Appleはソフトウェア開発者が使いやすいハードウェアを
作ることにかけては*本当に手を抜きません* :-)

最後に、M1 ProがM1 Maxの単なる縮小版であるということは興味深いことです。物理的にではなく（チップを半分にぶった切ることはできません）デザイン的にです。
割り込み番号やハードウェアアドレスはすべて同じです。つまり、事実上、同じSoCとして扱うことができるのです。私たちのM1 ProのDeviceTreeはM1 Maxのものまで
含んでいて、足りないビットを無効化/削除しているだけなのです。

## ワイルドなlinux-asahi登場!

この1年間多くの開発が別々のカーネルブランチで行われてきましたが、上流に統合される前の作業を集めた『公式』なカーネルブランチはありませんでした。多くのドライバが
上流に到達しプラットフォームのDeviceTreeも落ち着いてきたので、現在進行中の作業を共通のブランチに集め始める時期が来ました。

[linux-asahi](https://github.com/AsahiLinux/linux/tree/asahi)カーネルブランチにご挨拶を! このツリーは、最近の上流の開発に基づく最先端のカーネルで、
すでに上流に移行している、あるいは、人々にテストしてもらいたいほど使える状態にある変更点や新しいドライバが含まれています。今後、私たちが取り組んでいる最新のものを
テストしたいのであれば、ほとんどのユーザがこのカーネルを使うことになると思います。

このブランチは現在 linux-next をベースにしているため、安定したカーネルと捉えるべきではないことに注意してください。物事が進むにつれて、おそらく将来的には RC や
安定版のカーネルをベースとしたものに移行するでしょう。私たちは頻繁にリベースを行なっており、開発者が何か新しいことに取り組んでいてmainlineではまだ利用できない
機能が必要な場合はそれをベースにすることを推奨しますが、そうする前に git リベースとコミットのやり取りに慣れているか確認してください!

さらに、`asahi-soc/` パスの下には [asahi-soc/dt](https://github.com/AsahiLinux/linux/tree/asahi-soc/dt) のようなブランチもあります。これらのツリーは、
Apple ARM プラットフォームの Linux 向けメンテナとして、私たちが直接担当している Apple プラットフォームの作業を表しています。主に、デバイスツリーの変更と特定の
ドライバ（特に PMGR、さらにまもなくRTKit レイヤーも）の変更を意味しています。また、[asahi-soc/next](https://github.com/AsahiLinux/linux/tree/asahi-soc/next) 
ブランチには linux-next にマージされた最新の変更が含まれています(時々更新されています)。署名入りのプルリクエストを上流のLinuxメンテナに直接送るのはまだ少し変な感じがします！

注意: これらのブランチに対して GitHub PR を直接送信しないでください。頻繁にリベースされるためうまくいきませんし、カーネルでは開発モデルが異なる傾向があります 
(例えば、上流にパッチを提出する前にヒストリーを書き換えることが多く、これはオーサーシップに影響を及ぼします)。もしカーネルの修正や新しい開発に貢献したいのであれば、
[#asahi-dev]( https://asahilinux.org/community/)で私たちと話をすることをお勧めします。

## ドライバ、ドライバ、ドライバ!

この 2 ヶ月はカーネルドライバの活動でいっぱいでした! 多くのドライバが 5.16 にマージされ、さらに多くのドライバが 5.17に 向けられています。ここでは、
ハードウェアの対応状況を便利な表形式で見てみましょう。

(訳注: Githubのmarkdownの色や結合の制限のため表を画像にして貼り付けています)

### 凡例
![ドライバ状況表](https://github.com/asfdrwe/asahi-linux-translations/blob/main/table.png)

[前回の進捗報告](https://github.com/asfdrwe/asahi-linux-translations/blob/main/PROGRESS202109.md)で述べたドライバのうち、
Pinctrl、I²C、ASC Mailbox、および Device Power Management は現在統合されています。それに加えて、新しい M1 Pro/Max AIC2、
CPU PMU、SPI コントローラドライバのレビューと、多くのデバイスを正しく動作させるための修正も行っています。10G Mac Mini 用 Aquantia 
NICのMAC アドレスの処理、新しい MacBook 用 SD カードリーダーのための修正、新しい SimpleDRM ドライバを SimpleFB のように動作させるための修正、
USB2 ホットプラグ動作のための修正等です。

CPU周波数のスケーリングは提出しましたが、議論の結果、別の方法でドライバにアプローチしてみることにしましたので、これは近々書き直す予定です。
とはいえ、m1n1 は現在デフォルトですべてのコアを適切なパフォーマンスレベル (2GHz) に初期化しているので、5.17統合を逃しても大きな問題にはならないでしょう。
内蔵キーボードなど、重要なハードウェアを有効にするドライバを優先的に上流に統合しています。

[Martin Povišer氏](https://github.com/povik) は音声ハードウェアに尽力しており、彼の Linux ASoC ドライバが Mac Mini の内蔵スピーカーと
すべての M1 Mac のヘッドフォンジャックを駆動できるようになりました! Max/Proマシンでのスピーカー対応とジャック対応は、様々なスピーカーアンプ/コーデックチップへの
対応に依存します。これに加えて、彼は今後いくつかのラップトップのマルチスピーカーセットアップを正しく駆動する方法を調べるので、ソフトウェアでクロスオーバーフィルタを
実装する必要があります。ALSA、PulseAudio、PipeWireなどがユーザーから見てスピーカーの配置をステレオペアとして扱えるようにユーザー空間でこの要件をどのように
表現するかを考えなければならないでしょう。

最後に、[Janne Grunau氏](https://twitter.com/jaguar_9)は MacBook のキーボードとタッチパッドに対応するために、全く新しい Apple HID over SPI 
トランスポートドライバを書き上げました。Linux には Apple 形式のタッチパッドイベントを処理するドライバが既に合計 3 つあることが判明しました!
1 つは Intel システム用に SPI を使って書かれたものですが、基本的なプロトコルが HID であることを理解していません。1 つは生の USB デバイス 
(USB モードのタッチパッド) で動作するように書かれ、1 つは USB または Bluetooth を介して外部 Magic Mouse と Magic Touchpad デバイスで動作するように作られた
正しい HID レイヤードドライバです。既存の applespi キーボード/タッチパッドドライバにパッチを当ててテストしていましたが、このドライバは既存のカーネル機能の
多くを不完全に複製しているため、正しい方法でないことは明らかです。代わりに、新しい (ずっとシンプルな) HID トランスポートドライバを書くことで、Linux の標準
HID キーボード/マウスサポートと既存の Magic Touchpad HID ドライバ (おそらくいくつかのプロトコルが追加された) と一緒に動作させることができます。
将来的にはこれが Intel システム上の applespi も置き換え、カーネルが数千行の冗長なコードを失うことで全体のサーガが終わることを望んでいます。

## すべての人のためのDeviceTree
異なる機器間で異なる設定のデバイスのためのドライバが集まってきたため、各デバイスを特にカバーする適切なDeviceTreeを書く時期が来ました。Janne Grunau氏が
オリジナルの M1 Mac DeviceTreeをすべて追加するシリーズを提出し、私たちはそれを asahi-soc ツリーを通して統合しました。 これは 5.17 で上流に統合される予定です。
これは、M1 Mac Mini、MacBook Air、MacBook Pro、および 2 種類の iMac (2 USB ポートと 4 USB ポート) をカバーするものです。さらに、M1 Pro と Max マシンの
DeviceTreeは linux-asahi ブランチにあり、これらの機器用の新しいバインディングとドライバがマージされ次第、上流に統合されます (できれば5.17に)。

## U-Boot
Asahi Linux をエンドユーザがインストールするときには、U-Boot をブートステージとして使用してEFI サービスと基本 I/O を提供することで、標準的な UEFI 環境で
ディストリビューションを操作できるようにします。Mark Kettenis氏は U-Boot に M1 をサポートさせるために尽力しており、初期の対応パッチは統合されて 
U-Boot 2022.01 の一部となる予定です!

## 次回
次に注目したいのは、Wi-Fiです。今年の初めからWi-Fi対応パッチが出回っていますが、残念ながらファームウェアの扱い方が完全に後手に回っています。というのも、
正しいファームウェアを自動選択する代わりに、ユーザーが自分のマシンに必要な特定のファームウェアを掘り起こす必要があるからです（MACアドレスも手動で設定します）。
これには完全な書き直しとファームウェアコピーツールとの調整が必要です。私たちはどのように設計されるべきかについてかなり良いアイデアを持っているので、
ブートローダのインストーラにファームウェアのコピーとリネームを統合し、実行するプラットフォームに対して正しいファームウェアを要求する新しいパッチを書く予定です。
これにより、ユーザが何もしなくてもドライバが動作するようになり、Linuxインストールが異なる機器間でポータブルになります (少なくともrootファイルシステムに関しては)。
ACPI からいくつかの情報を取得するための追加作業により、T2 Mac でも動作するようになります。来週か再来週にはこの件に関するアップデートがありますのでお楽しみに!

また、バッテリー管理、ファンや温度制御などを担当するSMCについても見ていく予定です。Macには昔からSMCがあり、M1 macのSMCはすでによく知っている
RTKit ASCコプロセッサのフレームワークの上に同じコンセプトを引き継いでいるだけなのです。コアとなるインターフェイスはシンプルなキー/バリューストアで、
ここでの作業のほとんどは、ハードウェアのさまざまな側面を処理するためのサブドライバとして、利用できるすべての便利なキーへの対応を追加することです。

SPMIとRTC対応もすぐに取り組める簡単で良いドライバです。私たちはみんなNTP時間同期を実行していますが、誰も自分のコンピュータが1970年に起動するのを好まないので、
これもチェックすべき重要なチェックボックスです。ありがたいことにこれはとても簡単なのです。実際、Mark Kettenis氏の努力のおかげで、OpenBSD は
[すでに](https://man.openbsd.org/aplpmu.4)このハードウェアに対応しており、どのように動作するのかすでに知っています!

複数のマシンでカーネルをテストしている間、私は iMac の余分な 2 つの USB C ポートが動作しないことを発見しました。長いデバッグセッションの後、これらのマシンの
SB コントローラは、起動時にファームウェアをアップロードすることを要求していることが判明しました。これは、計画中のファームウェア・コピー・
インフラストラクチャーに依存するため、今のところ後回しになっていますが、これを動作させるために必要なカーネルの変更は複雑なものではありません。

もちろん、これらが片付いたらGPUカーネルドライバに取り組むことになりますよ！2022年は間違いなくAsahi Linuxにとってエキサイティングな年になるでしょう。

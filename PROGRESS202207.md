[M2 is here! July 2022 Release & Progress Report](https://asahilinux.org/2022/07/july-2022-release/)の非公式日本語訳です。

訳注: 
- Githubのmarkdownで使えないiframeでのtwitterへの埋め込みをリンクに置き換え
- ブログへのリンクを対応する日本語訳ページへのリンクに置き換え

---
# M2登場！ 進捗報告:2022年7月

- [前回](https://github.com/asfdrwe/asahi-linux-translations/blob/main/PROGRESS202203.md)

またまた久々の進捗報告へようこそ! いつものように予想以上に忙しく...だけどビッグニュースがあります！
Mac StudioとBluetoothと*M2に対応した*新しいAsahi Linuxのアップデートをリリースしました！

Asahi Linuxを初めてお使いになる方は、インストール方法と一般的な情報に関して
[前回のリリース告知](https://github.com/asfdrwe/asahi-linux-translations/blob/main/PROGRESS202203.md)をご確認ください。

## Mac Studioが家族の一員に

Mac Studioが発表されたとき、私たちは新しいM1 UltraをAsahi Linuxで動作させることに取り掛かりました。
これは難しいことではありませんでしたが、1つのSoCに複数のダイがあるというアイデアを扱うために、
ブートローダとDeviceTreeにいくつかの変更を加える必要がありました。これは結局、他の変更と一緒に
なってしまったので、リリースまで予想より少し長く待つことになってしまいましたが、ついにできました!

M1 Maxモデルの前面USBポートと全モデルのType Aポート（これらはM1 iMacの4ポート版にも必要な特別なファームウェアアップロード
対応上でブロック-リスト上に記載）を除いて、ほとんどのハードウェアは（Mac Miniと同等に）期待通りに動くと思っていただいて結構です。

## ワイルドなBluetooth登場！

Bluetoothはしばらく後回しになっていました。というのもAppleがどうやら他のベンダーは使っていない新しい特注のPCIeインターフェースに
切り替えたからです。しかし、[R氏](https://twitter.com/rqou_) がそのリバースエンジニアリングに挑戦したことで、
すべてが変わりました！ありがたいことに、ホストとコントローラのインタフェースはほぼ標準化されているので、Bluetooth自体は
非常に単純です。AppleはPCIe上で動作するものを作りましたが、上位レイヤーは他のBluetoothコントローラーと同じです。
R氏がユーザ空間の概念実証用ドライバをまとめた後、Sven氏がその作業を引き継ぎ、適切なカーネルドライバを書き始めました。
数日後、Bluetooth が動き出しました!

私たちは、思い切ってこのドライバをアルファユーザに直接提供することにし、最新のカーネルとサポートパッケージで
利用できるようになりました。ありがたいことに、PCIe トランスポートは新しいものですが、その上で動作する HCI 
インターフェースは標準的なものなので、ドライバのコアの初期化およびデータ転送部分が動作し始めたら、ほとんどの 
Bluetooth 機能も動作するようになりました。ドライバはそのような細かいことを気にする必要はなく、ただデバイスとの
間でデータをシャッフルするだけです。WiFiとBluetoothの共存がまだ適切に設定されていないため、2.4GHzのWiFi
ネットワークに接続している場合、Bluetoothのパフォーマンスが低下します。Bluetoothを使用したい場合は、
現時点ではWiFiをオフにするか、5GHzネットワークを使用することをお勧めします。

ドライバに加えて、Bluetooth 対応は、私たちが目指してきた『シームレスアップグレード』パラダイムを試す最初の
大きな試練となります。Asahi Linux はまだ実験的なプロジェクトですが、私たちは、新しいものを動作させるために、
ユーザに困難な手作業の手順を強いることはしたくないと考えていました。Bluetoothを有効にするには、スタックの
さまざまな部分に小さな変更を加える必要がありました:

- Apple DeviceTree から Linux DeviceTree に Bluetooth アドレスとキャリブレーション情報を転送するための m1n1 の変更
- 新しいデバイスを追加し、特定のマシンごとにハードウェアボードの種類を指定するためのDeviceTreeの変更
- Bluetooth ファームウェアを抽出し、Linux が見つけることができる正しい場所に配置するためのインストーラの変更
- 全く新しいLinuxドライバ
- Plasma デスクトップユーザー向けの新しいデフォルトパッケージの追加、および ```bluetooth.service``` を有効にする必要あり

このようなことが最初からわかっていたので、自動的にそのすべてに対応するリファレンスディストリビューションを設計しました:

- m1n1は2つのステージに分かれており、（ロジックの大部分を持つ）第2ステージは通常のパッケージとしてアップグレードすることが可能
- DeviceTreeはLinuxカーネルにバンドルされ、カーネルがアップグレードされるときにm1n1もアップグレードされるので、常に同期保持
- 既存のインストーラは、いくつかのファームウェアが欠けていることがわかっていたので、Linux から再処理できるようにすべての生のファームウェア（処理前）の『フォールバック』アーカイブを作成。インストーラのファームウェア処理コンポーネントを含む ```asahi-fwextract``` パッケージを追加し、インストール時にフォールバックアーカイブを入力として使用して、ファームウェアバンドルを自動的にアップグレード。
- デフォルトのインストールに空のメタパッケージを同梱し、既存のユーザのために、新しいパッケージを依存関係として追加。これを利用して、```asahi-fwextract``` を全員にインストールし、デスクトップユーザが良好な Bluetooth 体験を得るために必要な BlueZ/Bluedevil/etc の雑多なパッケージもインストール。また、アップグレード時に```bluetooth.service```を有効化

この結果、既存のリファレンスhttps://youtube.com/AsahiLinaのユーザは、パッケージをアップグレードして再起動するだけで、
それ以上の設定や変更なしにBluetoothが動作するようになります!

## M2登場！

Asahi Linuxが始まって以来、最もよく聞かれる質問のひとつが 『M2 はどうなるんだ？』 です。確かに、M1 は最初の一歩に過ぎず、
Apple は新しいチップやマシンのリリースをすぐに止めるつもりはないようです。このことは、Asahi Linuxプロジェクトにどのような
影響を与えるのでしょうか？　私たちは長い間、新しいチップへの移植は最初のときほどの挑戦にはならないだろうし、多くのドライバは
修正なしで動くだろうと考えてきました...そして M2 はこの理論の最初の真のテストとなります。どうだったでしょうか？

[たった12時間の立ち上げマラソン](https://www.youtube.com/watch?v=SidIJkC5YN0) の後、Linux が M2 で起動し、
USB、NVMe、電池統計/制御、CPUfreq、WiFi、その他が使えるようになりました! さらに数日の作業で、キーボードと
トラックパッドが動作するようになり、既存のシステムと同等の機能を実現することができました。さらにいくつかの統合作業を
経て、Asahi Linux のインストーラで *M2機器に実験的に対応すること*を誇りを持って発表します！

M2機器で試す場合は、以下の注意事項に留意してください：

- これは M1対応よりもさらに実験的なものなので、バグがあることが予想される。M2にインストールするためには、Asahi Linuxのインストーラでexpert modeを有効にする必要あり
- キーボードは U-Boot/GRUB では動作しない。このドライバはまだ書かれておらず、U-BootとLinuxの間のハンドオフをどのように行うかもまだわかってない。ブートローダのシェルをつつく必要がある場合は、外付けのUSBキーボードを使うことが可能
- M2 MacBook Pro 13インチのみテスト。M2 MacBook Air対応は完全に未検証で、私たちはまだ誰も持っていない。もし持っていても、よほど冒険したい気分のときだけ試してみて（そして、うまくいかなくても私たちを責めないで）
- Linux 用のファームウェア/スタブは、Apple がこれらの機器のためだけにリリースした『特別リリース』の macOS 12.4 バージョンがベース。私たちはまだこのバージョンの長期サポートを約束していないので、GPU や外部ディスプレイ出力などの将来の機能を動作させるには、macOS とインストーラを経由してブートコンポーネントを (おそらく 13.0 に) アップグレードしなければならないかもしれない (つまり、pacman だけでは『シームレスアップグレード』できないが、完全な再インストールも必要ない)。今後どのように進めるか決定し、必要であれば時期が来たらインストーラに必要なアップグレードモードを追加する予定。結局、12.4をサポートする可能性もあるが、約束はできない

## トラックパッドのトリック

トラックパッドで何が起こったのか、興味深い話なので見てみましょう。Apple MacBookは歴史的にキーボード/トラックパッドの部品に
面白いデザインを持っています。ほとんどのx86ラップトップでは、これらは（おそらく仮想）PS/2か、時にはUSBで内部に取り付けられていますが、Appleは最初USBで、その後SPIに移行しています。SPIはUSBよりもシンプルなプロトコルなので、ユーザーからの入力に常に反応する
必要があるこのような低帯域幅の周辺機器では電力を節約することができるのです。最新の（T2以前の）Intel MacBookでさえすでに
SPIを使用しており、このデザインはM1にも受け継がれています（T2マシンはここでは特殊なので割愛します）。

Appleはまた、実際のキーボード/トラックパッドにかなり異なるアーキテクチャを使用しています。多くのx86機器では、キーボードは
マザーボード上の専用チップである組み込みコントローラーで駆動され、他の多くのシステム管理機能を制御しています。トラックパッドは
通常独立しています。Apple機器では、対照的にトラックパッドがキーボードを管理しています。キーボードはx86機器と同じくパッシブスイッチマトリックスですが、マザーボードに直接接続するのではなく、代わりにトラックパッドに接続しています。トラックパッド自体も、
AppleのForce Touch技術によって、かなり変わったものになっています。他のほとんどのラップトップはSynapticsの専用
トラックパッドチップを使用していますが、Appleは代わりにBroadcomのBCM5976（iPhoneに搭載されているのと同じ、ARMコアが
埋め込まれたタッチスクリーンコントローラ）を採用し、STM32 Cortex-M3マイクロコントローラと組み合わせています。
STM32（RTKitファームウェアを実行）は、デザインのキーボードとForce Touch部分の処理を担当し、すべてのデータを結合して
Appleのトラックパッドをうまく動作させるアルゴリズムの一部を実装するBCM5976のフロントエンドとしての役割も果たします。
合わせて、これらのチップがファームウェアの賢さをかなり備えています。

それからM2が登場して、SPIインターフェイスがなくなりました。いや、なくなったわけではないんですが...OSからはもう見えないんです。
その代わり、M2にはもう一つの小さな秘密、MTPがあります。そう、AppleはトラックパッドコントローラーをメインSoCに移したのです！

そう、正確には違うんです。BCM5976とSTM32はまだそこにありますが、どちらのファームウェアも劇的に縮小されました。これらのチップは、
もはや派手なマルチタッチ アルゴリズムやロジックを担当するのではなく、生のキーボード/マルチタッチ/Force Touch データを M2 に
取り込むための単なるインターフェース チップに追いやられています。M2 には専用のコプロセッサー（おそらく別の ARM64 Chinook 
インスタンスで、通常通り RTKit を実行）があり、これが処理の大部分を担当しています。

なぜAppleはこのようなことをするのでしょうか。いくつかの理由があります。まず、ファームウェアをM2に統合することで、アップデートの
柔軟性が高まります。このファームウェアは、OSごとのバンドルに含まれるため、古いバージョンのmacOSとの後方互換性を損なうことなく、
新機能の導入や変更を行うことができるようになりました。また、ファームウェアのアップグレード手順は、macOSのアップグレードと
自動的に統合され、より強固になります。そしてもちろん、より小型のSTM32を使用してコストを削減することも可能です。

MTPを利用して、AppleはメインOSとの通信を興味深い方法で処理しました。ほとんどのコプロセッサは主要なメールボックス/RTKit
インターフェースと共有メモリを使用していますが、AppleはSPIインターフェースの『bytes in, bytes out』デルを維持したかったようで、
その代わりにDockChannelを使用しました... Dockchannelとは一体何でしょうか？これはAppleが独自に設計したもので、
基本的にはシンプルなFIFOです。M1チップはすでにデバッグDockChannelを実装しており、Macの特定のType Cポートに接続する
Appleの内部デバッガでアクセスできる仮想シリアルポートとして使用できます（[少し調べました](https://github.com/asfdrwe/asahi-linux-translations/wiki/HW:Debug-USB) が、このプロトコルがUSB側でどう動作するかはまだ分かっていません）。
MTP は同じ FIFO モジュールをメイン OS との間の単純なバイトチャンネルとして再利用し、その上で新しい HID トランスポート
プロトコルが実行されます。

良いニュースは、DockChannel自体が非常にシンプルなので、それを動かし始めるのに時間がかからなかったことです。悪いニュースは、
Apple が新しい HID トランスポートを複雑にしすぎたため、新しいドライバが [1000 行以上のコード](https://github.com/AsahiLinux/linux/blob/asahi/drivers/hid/dockchannel-hid/dockchannel-hid.c) になり、ファームウェアのアップロードや GPIO プロキシ、
複数の複雑なネストしたデータ構造といったものを扱わなければならなくなったことです！ また、MTPをリセットして新しい起動状態に戻す方法が
まだわかっていないので、U-BootドライバとLinux間のハンドオフや、Linuxでのデバイスの取り外し/再検出にまだ対応できていません。

さらに呪われたことに、BCM5976のファームウェアは、ホストからの起動時にロードされることが判明しました。macOS はそれを asn.1 img4 イメージに包まれた XML plist (Python XML plist パーサーが対応しない機能を含む) として保存し、ドライバは初期化中に MTP に渡す前にそれをバイナリシリアライズ構造 (さらに別のシリアライズ形式で...) に変換し、さらに bInterfaceNumber フィールドに正しいインターフェース番号をパッチする必要があります。言うまでもなく、私たちはLinuxカーネルにXMLパーサを入れているわけではないので、代わりにAsahi Linuxの
インストーラはバイナリ形式に変換する[モジュール](https://github.com/AsahiLinux/asahi-installer/blob/main/asahi_firmware/multitouch.py) を持つようになりました。bInterfaceNumberのオフセットを含む小さなヘッダがあるので、LinuxはMTPに渡す前に
それを変更することができます。ふぅ〜。

## Venturaの冒険
macOS 13.0 Venturaベータ版リリース後、Asahi Linuxのインストールが壊れるという報告を受けました。私たちは、ほとんどの
ファームウェアはOSに関連しているので、macOSのアップグレードはAsahiを壊さないはずだとしばらく主張してきました
（だからmacOSのアップグレードはAsahiには影響しません）。では、何が起こったのでしょうか？

ほとんどのファームウェアはOSに関連していますが、システムファームウェアの中には、すべてのOSに共有されている小さなサブセットがあります。
これには、NVMeファームウェア（明白な理由あり）、SMCファームウェア、およびいくつかのThunderbolt関連のものが含まれます。しかし、
古いバージョンのmacOSとの互換性を維持するために、Appleは基本的に古いファームウェアとの後方互換性を壊さないことを約束しているので、
私たちは安全なはずです。

そして、バグがなければ...安全だったでしょう! 実際、m1n1のNVMeドライバは、アップデートされたファームウェアに何の問題もなく、
箱から出してすぐに動きました。しかし、U-Bootの方は、それほど幸運ではありませんでした。そのバージョンはClever ShortcutTMを
使用していて、新しいファームウェアが私たちの小さなトリックに満足しないことが判明しました。一方、Linux SMC ドライバには、
古いファームウェアでは気づかなかった明らかな一行バグがあり、新しい SMC ファームウェアをクラッシュさせました。

linux-asahi、u-boot、m1n1 パッケージを更新したので、もし新しいベータを試したいなら、まず pacman upgrade をしてください！
もし既にベータにアップグレードしてしまっていて、Asahi システムが起動できなくなった場合は、[こちら](https://github.com/AsahiLinux/asahi-installer/issues/100#issuecomment-1162376171)の手順に従って復旧してください。

これらの問題は私たちのコードのバグや見落としが原因であり、Apple が互換性を壊しているわけではないことを心に留めておいてください。
一般的には、AsahiがインストールされているMacをアップデートするのは常に安全ですが、バグに噛まれないようにしてください :-)

## お願い、DCP！

Mac Mini（そして現在のMac Studio）は、長い間、起動プロセス中に、HDMI出力と特定のモニターとの信頼性の問題を抱えていました。
Appleは以前、OSが立ち上がる前に実際にディスプレイを初期化していましたが、（デスクトップでは）macOS 12.0から完全にそれをやめました。
しかし、Asahi Linuxにはまだ適切なディスプレイコントローラドライバが同梱されておらず、また、m1n1、U-Boot、grubのブート画面を
表示できる必要があるので、ブート時のフレームバッファをセットアップするためにm1n1でディスプレイを初期化する必要があります。
これはうまくいきますが、問題は、ブートプロセス中にアクティブに動作するディスプレイドライバがない場合、DCP
(the Display Controller Processor) が新しいモードセットコマンドを待つ間にそれをシャットダウンするので、ホットプラグ
イベントはディスプレイを失わせる原因になるということです。残念ながら、一部のモニタでは、スタンバイ状態から起動すると、数秒後に
事実上入力が切断され、再び接続されるという奇妙に壊れた動作をするようです。m1n1はディスプレイを初期化して移動し、モニタは偽の
ホットプラグイベントを発生させて、DCPは信号をシャットダウンします。

そして Asahi Linux はまだカーネルに適切な DCP ドライバを同梱していないので、これは完全に壊れたディスプレイを意味します
(これはすぐに修正される予定ですが、我々はまだブートローダのグラフィックスを動かしたいのです...)。これを解決するために、
モニターが完全に安定する前に長い起動遅延を導入するテストパッチがいくつかありましたが、これは不完全な解決策であり、
すべての人に起動遅延を与えるという考えや、インストール時に自分のモニターに回避策が必要かどうかをユーザーに決定させることは
好ましくありません。

この問題に対する何らかの解決策、おそらくホットプラグイベントに反応しないようにするためのDCPコマンドを見つけようとあちこち
探しましたが、見つかりませんでした。そこで思いついきました。DCPをシャットダウンできないかな...DCPのリバース・エンジニアリングを
始めた頃、クラッシュした後に適切にリセットできないことは分かっていましたし、シャットダウン・モードがどのように機能するのかも
明らかではありませんでした。DCPは起動したままでなければならず、完全に停止させるとすべてが壊れてしまうような気がしたのです。
しかし、その後、RTKit の電源モードがどのように機能するか、コプロセッサを正しくシャットダウンする方法、およびフルパワーダウン
（NVMe などで使用）後に復帰させる方法についての理解が深まりました。そこで、新しい既知の完全なシャットダウン手順を
試してみたところ...うまくいきました！ DCP が停止しているので、モニターのホットプラグイベントに反応することはありません。
HDMI 信号は、モニターが何をしているのかに関係なく、ただその場に留まっています。DCPのシャットダウンは制御された方法で
行われるので、Linuxは本物のドライバが利用可能になれば何の問題もなくそれを起動させることができます。

(m1n1が画面モードを設定してからDCPをシャットダウンするまでの間にモニターがホットプラグされた場合）まだ小さな競合がありますが、
それは小さな窓です。実際上、知りうる限り、この新しいアプローチによって、影響を受けるすべての人の表示上の問題が解消されました。
このアップデートにより、Linux の使用中にモニターのプラグを抜いたり電源を落としたりしても、次に電源を入れたときに信号が
途絶えることがなくなりました。システムをアップデートして、新しいm1n1を手に入れましょう！

DCPについて話している間に、Apple機器は最近、DCPを使用してシステムを侵害する[高度なマルウェア](https://googleprojectzero.blogspot.com/2022/06/curious-case-carrier-app.html) の対象となりました。私たちが
（まだ出荷していない）Asahi LinuxのDCPドライバを開発したとき、私たちはすでにDCPを潜在的に危険で敵対的であるとみなして開発
しました。さらに、DCPを悪用できるような方法でユーザー空間に直接公開することもしていません。なお、Asahi Linux では
macOS/iOS と同じ脆弱性のある DCP ファームウェアを使用していますが、本脆弱性は影響しませんのでご安心ください。

## DARTの転用

M1 ProとM1 Max/Ultraは、新しいDART（IOMMU）ハードウェアのバリエーションも導入し、Thunderboltポートやメディアコーデック
関連のハードウェアの一部に使用しています。R氏がすでにこれをリバースエンジニアリングしていましたが、まだ適切なドライバが
ありませんでした。M2 がこの IOMMU バリアントをずっと使っていることがわかったので、M2 を立ち上げる過程で m1n1 と Linux 対応を
追加しました。これだけでは、M1 Pro/Max で新しいものが動くようにはなりませんが、Thunderbolt とメディアハードウェアの
要件は満たしていますので、これでまた一つ箱が増えました。

同目的で、Jannau氏がPro/Max の上流にある他の DART バリアントのサポートを追加するパッチセットを提出しました。Asahi派生で
これらのチップに対応してきましたが、上流のメンテナが、ARM IOMMU ページテーブルコードに Apple 固有のページテーブルのquirk(癖)を
加えることに完全に満足していないため、上流ではブロックされていました。これを別のファイルに移動することで、ブロックが解除され、
最終的に 上流でM1 Pro/Max 対応できると期待しています（少なくとも、上流Linux が既に M1 で起動できるように、このチップで
起動するには十分です；もちろん、フル機能のために上流に送るべき他のドライバーがまだ残っています）。

## U-Boot の更新

U-Boot対応は順調に進んでいます。U-Boot 2022.07 がリリースされ、M1 モデル (M1 Pro/Max/Ultra を含む) を (ほぼ) 完全に
対応し、 (Janne Grunau氏のおかげで) M2 の基本対応が行われました。最も重要なのは、Mac mini のType-A ポートの後ろにある
PCIe USB3 コントローラへの対応です。

## Linuxだけでなく

OpenBSD 7.1が2022年4月21日にリリースされ、M1およびM1 Pro/Max/Ultraに対応しました。これには、NVMe、USB（USB 2.0速度は
Type-Cポートのみ）、WiFi、Ethernet（M1 miniとiMac）、キーボードとタッチパッド（ノートパソコン）への対応が含まれます。
X11は初期のフレームバッファで動作し、音声対応は現在作業中です。OpenBSD は、まだ新しい M2 モデルに対応していませんが、
これは 11 月にリリースが予定されている OpenBSD 7.2 の眼下にあります。

OpenBSD は、U-Boot をペイロードとする m1n1 のみをインストールするオプションを提供する Asahi インストーラに依存しています。
これにより、OpenBSD/arm64 が対応する他のハードウェアと同じように、 標準的な UEFI ブート環境が得られます。この時点で、
単に minirootXX.img や installXX.img を USB ドライブに書き込んで、それを Mac に接続し、 OpenBSD のインストーラを
起動することができるようになります。

OpenBSD のインストーラは、魔法の Apple パーティションについて知っているので、 インストーラでデフォルトの (W) hole 
ディスクオプションを選択しても、 システムパーティションは生き残り、あなたの macOS のインストールは安全です。OpenBSD の
インストーラは、WiFi ファームウェアも自動的にピックアップします (EFI システムパーティションから。Asahi のインストーラは
これを準備します)。これは、インストール中に WiFi が利用できることを意味します。

## もう1つ...

みなさんが何を考えているかわかります...GPUはどうなるのでしょうか？

[埋め込みツイート](https://twitter.com/LinaAsahi/status/1537828477352615936)

良いニュースです！数ヶ月前、[Asahi Lina氏](https://twitter.com/LinaAsahi)がチームに加わり、M1 GPU
ハードウェア・インターフェースのリバースエンジニアリングとそのためのドライバ作成に挑戦してくれました。この短期間に、
彼女は、既存のMesaの作業の上に構築して、実際のグラフィックス・アプリケーションやベンチマークを実行するのに十分な
プロトタイプドライバをすでに構築しています。概念実証で、USB 接続経由で m1n1 を使用し、ドライバをリモートで
実行しています。そのため、USB 帯域幅がボトルネックとなりますが、GPU が GLMark2 phong shaded bunny シーンを
解像度 1080p で 1000FPS 以上で適切にレンダリングすることも実証しています。この完全なオープンソーススタックは、
dEQP-GLES2テストスイートの[94%](https://twitter.com/LinaAsahi/status/1546301886147731457)に合格しています。
悪くないです！

近いうちに、Lina氏によるGPUドライバの全容を紹介するゲスト投稿を掲載する予定です。ご期待ください。もし興味があれば、[YouTube](https://youtube.com/AsahiLina)で彼女の仕事をフォローすることができます。

#### marcan 2022-07-18

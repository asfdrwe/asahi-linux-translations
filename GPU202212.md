[Apple GPU drivers now in Asahi Linux](https://asahilinux.org/2022/12/gpu-drivers-now-in-asahi-linux/)の非公式日本語訳です。

---
# Asahi LinuxにApple GPUドライバ登場

- [前回](https://github.com/asfdrwe/asahi-linux-translations/blob/main/GPU202211.md)
 
みなさん、こんにちは。Apple Silicon GPU ドライバの初公開を発表できて興奮しています！
この新しいドライバを皆さんにお届けするために、過去2年間懸命に働いてきました。そして、ついにここまでたどり着いたことを本当に誇りに思います。
これはまだアルファドライバですが、すでにスムーズなデスクトップ体験といくつかのゲームを実行するのに十分な性能を持っています。

現在の状態やインストール方法（オプトインパッケージです）やバグの報告方法についてもっと詳しく知りたい方はこちらをお読みください！

![image](https://asahilinux.org/img/blog/2022/12/quake3.png)

## 現状

このリリースでは、現在のすべての Apple M シリーズシステムに対して、作業中の OpenGL 2.1 および OpenGL ES 2.0 に対応しています。
これは GNOME や KDE のようなデスクトップ環境でのハードウェアアクセラレーションには十分なものです。また、Quake3やNeverballの
ような古い3Dゲームにも十分です。改善の余地は常にありますが、ドライバは上記のすべてを4Kで60フレーム/秒で動作させるのに十分な
速度を持っています。

注意：これらのドライバはまだOpenGL (ES)の適合性テストに合格していません。バグが発生する可能性があります！

次は何でしょう？より多くのアプリケーションに対応することです。OpenGL (ES) 2で十分なアプリケーションもありますが、
新しいアプリケーション（特にゲーム）はより多くのOpenGL機能を必要とします。OpenGL (ES) 3は、複数のレンダーターゲット、
マルチサンプリング、変形フィードバックなど、多数の新機能を提供します。これらの機能の開発は順調に進んでいますが、
それぞれ追加の開発労力が必要で、OpenGL（ES）3.0が利用可能になる前にすべて必要となります。

Vulkanについてはどうでしょうか？今取り組んでいます！今はOpenGLしかリリースしていませんが、Vulkanも視野に入れて
設計しています。OpenGLのために行っている作業のほとんどは、Vulkanにも再利用されます。Vulkan 1.0ドライバが
動作することよりも、OpenGL 2ドライバが動作することの方がずっと早くリリースできると見積もっており、ハードウェア
アクセラレーションによるデスクトップをできるだけ早くユーザーの手に渡したいと思っていました。ほとんどの場合、
デスクトップはOpenGLを使用しているので、Vulkanに深く入り込み、デスクトップを実行するためにOpenGL 2を
Vulkanに変換するためにZinkを使用するよりも、OpenGLを最初にサポートする方が理にかなっていると考えました。
さらに、OpenGL対応には大きなスペクトルがあり、OpenGL 2.1にはOpenGL 4.6の機能の何分の1かが含まれています。
Vulkanについても同様で、ベースラインのVulkan 1.0プロファイルはOpenGL ES 3.1とほぼ同等ですが、最近の
アプリケーションでは、大量の拡張機能と『オプション』機能を備えたVulkan 1.3が求められています。Zinkの
OpenGLをVulkanの上に『重ねる』ことは、魔法ではありません：基礎となるVulkanドライバが持っている
OpenGL機能のみを公開することができます。ベースラインのVulkan 1.0ドライバは、ZinkでOpenGL 2.1を実現するのに
十分ではないのです！ Zink自体はOpenGL 4.6対応を宣伝していますが、もちろんそれは、OpenGL 4.6と同等のものに対応
Vulkanドライバと組み合わせた場合のみです...そしてそれは、途方もない時間と労力の話に戻ってしまうのです。

OpenGL 3対応はいつになるのでしょうか？OpenGL 4は？Vulkan 1.0？Vulkan 1.3は？コミュニティのオープンソース・プロジェクトでは、
誰かがある機能がいつできるかを尋ねるたびに、その機能が1ヶ月遅れる、と言われています。まあ、多くの人が質問しているのですが...

とにかく、SuperTuxKartの遅延レンダラがフルスピードで動作している様子をご覧ください。

![image](https://asahilinux.org/img/blog/2022/12/supertuxkart-dr.png)

## GPU ドライバを解剖

最新の GPU は、多くの異なる『層』の部品で構成されています。次のようになります。

- メモリ管理ユニットとメモリマップドワークをハードウェアに送信するインターフェイス
- 三角形のラスタライズや深度/ステンシルテストなどを行う固定機能 3Dハードウェア
- プログラム可能な『シェーダコア』（特注の命令セットを持つ小さなCPUのようなもの）と固定機能ハードウェアによってディスパッチされる作業

この『階層化された』ハードウェアは、『階層化された』グラフィックスドライバスタックを要求します。必要なものは...

- メモリをマッピングし、メモリマッピングされた仕事内容を送信するカーネルドライバ
- OpenGLとVulkanの呼び出しをグラフィックスメモリ内のハードウェア固有のデータ構造に変換するユーザースペースドライバ
- GLSLのようなシェーディングプログラミング言語をハードウェアの命令セットに変換するコンパイラ

これは大変な作業で、チームワークが必要なのです。幸いなことに、このような層を重ねることで、少人数のチームでも
自然に仕事を分担することができるようになりました。

- [Alyssa Rosenzweigさん](https://social.treehouse.systems/@alyssa) OpenGLのドライバとコンパイラを記述しています
- [朝日リナさん](https://vt.social/@lina) カーネルドライバを書き、OpenGLを手伝っています
- [Dougall Johnsonさん](https://mastodon.social/@dougall) Alyssa氏と一緒に命令セットのリバースエンジニアリングを実行しています

一方、[Ella Stanforthさん](https://tech.lgbt/@ella)は、カーネルドライバ、コンパイラ、およびOpenGLドライバと
共有するいくつかのコードを再利用して、Vulkanドライバに取り組んでいます。

もちろん、私たちだけでOpenGLドライバを2年以内に構築することはできませんでした。フリーソフトやオープンソースの力を借りて、
FOSSの巨人たちの肩の上に立っているのです。コンパイラは『NIR』バックエンドを実装しており、NIRはGLSLからNIRへの変換を含む、
強力な中間表現です。カーネルドライバは、Linuxカーネルの『Direct Rendering Manager』（DRM）サブシステムを使用し、
定形部分を最小限に抑えています。最後に、OpenGLドライバは、オープンソースのOpenGLおよびVulkanドライバのホームである
[Mesa](https://mesa3d.org/)の内部に『Gallium3D』APIを実装しています。MesaとGallium3Dを通じて、
30年にわたるOpenGLドライバ開発の恩恵を受け、共通のコードでOpenGLをよりシンプルなGallium3Dに変換しています。
NIR、Mesa、Gallium3Dの素晴らしいエンジニアリングのおかげで、私たちのような有象無象のリバースエンジニアリングチームが、
残された部分、つまりAppleのハードウェアに集中することができるのです。

## インストール方法

新しいドライバを入手するには、``linux-asahi-edge`` カーネルを実行し、さらに ``mesa-asahi-edge`` Mesa パッケージをインストールする必要があります。

```shell
$ sudo pacman -Syu
$ sudo pacman -S linux-asahi-edge mesa-asahi-edge
$ sudo update-grub
```

一度に1つのバージョンの Mesa しかインストールできないので、pacman は mesa を mesa-asahi-edge に置き換えるように指示します。これは正常です!

また、この時点では Xorg の代わりに Wayland を動かすことを推奨しているので、KDE Plasma 環境を使っている場合は Wayland セッションを必ずインストールしてください。

```shell
$ sudo pacman -S plasma-wayland-session
```

再起動してから、ログイン画面の一番上にあるWaylandセッションを選び(SDDM)、お楽しみください！
`システム設定` → `ディスプレイとモニタ`で画面の拡大率を調整するとよいでしょう (Plasma Waylandのデフォルトは100%か200%ですが、
150%の方がきれいな場合が多いです)。外観 → フォントで『フォントのDPIを強制する』を有効にしている場合は、これを無効にしてください 
(これはWaylandとXorgで別々に保存されているので、Waylandセッションで必要なことはないはずです)。ログアウトして再ログインすると、
これらの変更が完全に適用されます。

Xorg と Xorg ベースのデスクトップ環境は動作するはずですが、いくつかの既知の問題があります。
- 画面のテアリングが発生します(これは[すぐに](https://gitlab.freedesktop.org/xorg/xserver/-/merge_requests/1006)修正されるかも)
- VSyncが動きません (一部のKDEアニメーションは速すぎ、GLアプリはVSyncを有効にしてもFPSが制限されない)。これは Apple DCP ディスプレイコントローラ上の Xorg の制限で、VBlank 割り込みに未対応です
- Xorg/KWinによって引き起こされるドライバのバグがまだあり。これについては調査中です。

``linux-asahi-edge`` カーネルは標準の ``linux-asahi`` パッケージと一緒にインストールできますが、両方のバージョンは
同期している必要がありますので、常に一緒にパッケージを更新するようにしてください! GRUB ブートメニューで ``linux-asahi`` カーネルを選択すると、
GPU アクセラレーションと DCP ディスプレイドライバが無効になります。

今後パッケージが更新された場合、更新後に再起動するまでグラフィックアプリが起動しなくなったり、ソフトウェアレンダリングに
フォールバックする可能性があります。これは正常な状態です。UAPI が安定するまでは、Mesa とカーネル間の互換性を
時々破壊しなければならないので、アップデート後に動作させるためには再起動が必要になります。一般に、特定の Mesa 
アップデート後にアプリがアクセラレーションで動作し続ける場合は、おそらく再起動しなくても安全ですが、最新の
カーネルを実行していることを確認するために再起動する必要があります!

## バグの報告

ドライバはまだ開発中のため、多くの既知の問題があり、適合試験の結果を改善するために一生懸命取り組んでいます。
アプリが動かないからといって、新しいバグをオープンしないでください。まだ開発初期であり、やるべきことが
たくさんあることは分かっています。ここでは、バグを報告する方法について簡単に説明します。

- 全く起動しないアプリを見つけた場合、バグとして報告しないでください。多くのアプリは、対応しているものよりも新しいGLバージョンを必要とするため、動作しません。これらのアプリがソフトウェアレンダリングにフォールバックするように、``LIBGL_ALWAYS_SOFTWARE=1`` 環境変数をセットしてください。もしArch Linux ARM リポジトリに含まれる人気のあるアプリであれば、代わりに[この issue](https://github.com/AsahiLinux/linux/issues/73) にコメントを書いてください、そうすれば回避策として Mesa quirks を追加することができます。
- GPU とは関係なく ``linux-asahi-edge`` によって引き起こされる問題に遭遇した場合は、[この issue](https://github.com/AsahiLinux/linux/issues/70) にコメントを追加してください。これにはディスプレイ出力の問題も含まれます！ (解像度、バックライト制御、ディスプレイの電力制御など)
- GPUがロックアップし、すべてのGPUアプリが動作しなくなった場合、``asahi-diagnose``を実行し（例えば、SSHセッションから）、[AsahiLinux/linux](https://github.com/AsahiLinux/linux)に新しいバグをオープンし、そのコマンドで生成したファイルを添付し、ロックアップの原因となった行為を教えてください。
- その他のGPUの問題（レンダリングの不具合、正常に起動したアプリがクラッシュする、など）については、``asahi-diagnose``を実行し、[この issue](https://github.com/AsahiLinux/linux/issues/72)でコメントを書き、そのコマンドによって生成されたファイルを添付してください。その際、そちらの環境について忘れずにお聞かせください！
- 将来的には、ドライバの更新がリグレッション (以前は正常に動作していたアプリケーションのレンダリング問題やクラッシュ) を引き起こした場合、[Mesa トラッカー](https://gitlab.freedesktop.org/asahi/mesa/-/issues)で直接バグを開くことができます。

私たちのドライバを楽しんでいただけるとうれしいです！このため、定期的にパッケージをアップデートして、アップデートとバグフィックスを取得するようにしてください。

#### Alyssa Rosenzweig & 朝日リナ · 2022-12-07


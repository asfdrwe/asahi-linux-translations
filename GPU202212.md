[Apple GPU drivers now in Asahi Linux](https://asahilinux.org/2022/12/gpu-drivers-now-in-asahi-linux/)の非公式日本語訳です。

訳注
- まだDeepLの結果をはって、リンクを付けたり修飾をつけただけ

---
# Asahi LinuxにApple GPUドライバ登場

- [前回](https://github.com/asfdrwe/asahi-linux-translations/blob/main/GPU202211.md)
 
皆さん、こんにちは。私たちは、Apple Silicon GPU ドライバの初公開を発表できることに興奮しています!
私たちはこの新しいドライバを皆さんにお届けするために、過去2年間懸命に働いてきました。そして、ついにここまで来たことを本当に誇りに思います。
これはまだアルファドライバですが、スムーズなデスクトップ体験といくつかのゲームを実行するにはすでに十分な性能を持っています。

今日の状態、インストール方法（オプトインパッケージです）、バグの報告方法についてもっと詳しく知りたい方はこちらをお読みください！

![image](https://asahilinux.org/img/blog/2022/12/quake3.png)

## 状況

このリリースでは、現在のすべての Apple M シリーズシステムに対して、作業中の OpenGL 2.1 および OpenGL ES 2.0 をサポートしています。これは GNOME や KDE のようなデスクトップ環境でのハードウェアアクセラレーションには十分なものです。また、Quake3やNeverballのような古い3Dゲームにも十分です。常に改善の余地はありますが、ドライバは上記のすべてを4Kで60フレーム/秒で動作させるのに十分な速度を持っています。

注意：これらのドライバはまだOpenGL (ES)の適合性テストに合格していません。バグが発生する可能性があります。

次は何でしょう？より多くのアプリケーションをサポートすることです。OpenGL (ES) 2で十分なアプリケーションもありますが、新しいアプリケーション（特にゲーム）はより多くのOpenGL機能を要求します。OpenGL (ES) 3は、複数のレンダーターゲット、マルチサンプリング、変形フィードバックなど、多数の新機能を提供します。これらの機能の開発は順調に進んでいますが、それぞれ追加の開発労力が必要で、OpenGL（ES）3.0が利用可能になる前にすべてが必要になります。

Vulkanについてはどうでしょうか？取り組んでいます。今はOpenGLしか出荷していませんが、Vulkanも視野に入れて設計しています。OpenGLのために行っている作業のほとんどは、Vulkanにも再利用されます。私たちは、Vulkan 1.0ドライバが動作するよりも、OpenGL 2ドライバが動作する方がずっと早く出荷できると見積もっており、ハードウェアアクセラレーションによるデスクトップをできるだけ早くユーザーの手に渡したいと思っていました。ほとんどの場合、デスクトップはOpenGLを使用しているので、Vulkanの深みにはまり、デスクトップを実行するためにOpenGL 2をVulkanに変換するためにZinkを使用するよりも、OpenGLを最初にサポートする方が理にかなっていると考えました。さらに、OpenGLのサポートには大きなスペクトルがあり、OpenGL 2.1にはOpenGL 4.6の機能の何分の1かが含まれています。Vulkanについても同様で、ベースラインのVulkan 1.0プロファイルはOpenGL ES 3.1とほぼ同等ですが、最近のアプリケーションでは、大量の拡張機能と「オプション」機能を備えたVulkan 1.3が求められています。ZinkのOpenGLをVulkanの上に「重ねる」ことは、魔法ではありません：それは、基礎となるVulkanドライバが持っているOpenGL機能のみを公開することができます。ベースラインのVulkan 1.0ドライバは、ZinkでOpenGL 2.1を実現するのに十分でもないのです！ Zink自身は、OpenGLのサポートを宣伝しています。Zink自体はOpenGL 4.6のサポートを宣伝していますが、もちろんそれは、OpenGL 4.6と同等のものをサポートするVulkanドライバと組み合わせた場合のみです...そしてそれは、途方もない時間と労力の話に戻ってしまうのです。

OpenGL 3のサポートはいつになるのでしょうか？OpenGL 4は？Vulkan 1.0？Vulkan 1.3は？コミュニティのオープンソース・プロジェクトでは、誰かがある機能がいつできるかを尋ねるたびに、その機能が1ヶ月遅れる、と言われています。まあ、多くの人が質問しているのですが...。

とにかく、SuperTuxKartの遅延レンダラがフルスピードで動作している様子をご覧ください。

![image](https://asahilinux.org/img/blog/2022/12/supertuxkart-dr.png)

## GPU ドライバの解剖学

最新の GPU は、多くの異なる「層」の部品で構成されています。そこには

- メモリ管理ユニットと、メモリマップドワークをハードウェアに送信するインターフェイス
- 三角形のラスタライズ、深度/ステンシルテストなどを行う固定機能 3Dハードウェア
- プログラム可能な「シェーダコア」（特注の命令セットを持つ小さなCPUのようなもの）、固定機能ハードウェアによってディスパッチされる作業。

この「階層化された」ハードウェアは、「階層化された」グラフィックスドライバスタックを要求します。必要なものは...

- メモリをマッピングし、メモリマッピングされた作業を送信するカーネルドライバ
- OpenGLとVulkanの呼び出しをグラフィックスメモリ内のハードウェア固有のデータ構造に変換するユーザースペースドライバ
- GLSLのようなシェーディングプログラミング言語をハードウェアの命令セットに変換するコンパイラ

これは大変な作業で、チームワークが必要なのです。幸いなことに、このようなレイヤーを重ねることで、少人数のチームでも自然に仕事を分担することができるようになりました。

- [Alyssa Rosenzweig氏](https://social.treehouse.systems/@alyssa) OpenGLのドライバとコンパイラを執筆
- [Asahi Lina氏](https://vt.social/@lina) カーネルドライバを書き、OpenGLを手伝う
- [Dougall Johnson氏](https://mastodon.social/@dougall) Alyssa氏と一緒に命令セットのリバースエンジニアリングを実行

一方、[Ella Stanforth氏](https://tech.lgbt/@ella)は、カーネルドライバ、コンパイラ、およびOpenGLドライバと共有するいくつかのコードを再利用して、
Vulkanドライバに取り組んでいます。

もちろん、我々だけでOpenGLドライバを2年以内に構築することはできませんでした。フリーソフトやオープンソースの力を借りて、FOSSの巨人たちの肩の上に立っているようなものです。コンパイラは「NIR」バックエンドを実装しており、NIRはGLSLからNIRへの変換を含む、強力な中間表現である。カーネルドライバは、Linuxカーネルの「Direct Rendering Manager」（DRM）サブシステムを使用し、ボイラープレートを最小限に抑えています。最後に、OpenGLドライバは、オープンソースのOpenGLおよびVulkanドライバのホームである
[Mesa](https://mesa3d.org/)の内部に「Gallium3D」APIを実装しています。MesaとGallium3Dを通じて、我々は30年にわたるOpenGLドライバ開発の恩恵を受け、
共通のコードでOpenGLをよりシンプルなGallium3Dに変換しています。NIR、Mesa、Gallium3Dの素晴らしいエンジニアリングのおかげで、私たち有象無象の
リバースエンジニアリングチームは、残されたもの、つまりAppleのハードウェアに集中することができるのです。

## インストール方法

新しいドライバを入手するには、``linux-asahi-edge`` カーネルを実行し、さらに ``mesa-asahi-edge`` Mesa パッケージをインストールする必要があります。

```shell
$ sudo pacman -Syu
$ sudo pacman -S linux-asahi-edge mesa-asahi-edge
$ sudo update-grub
```

一度に1つのバージョンの Mesa しかインストールできないので、pacman は mesa を mesa-asahi-edge に置き換えるように指示します。これは正常です!

また、この時点では Xorg の代わりに Wayland を動かすことを推奨しているので、KDE Plasma 環境を使っている場合は Wayland セッションを必ずインストールしてください。

```shell
$ sudo pacman -S plasma-wayland-session
```

そして再起動し、ログイン画面の一番上にあるWaylandセッションを選んでください(SDDM)、そしてお楽しみください! 
システム設定 → ディスプレイとモニタで画面の拡大率を調整するとよいでしょう (Plasma Waylandのデフォルトは100%か200%ですが、
150%の方がきれいな場合が多いです)。外観 → フォントで「フォントのDPIを強制する」を有効にしている場合は、これを無効にしてください 
(これはWaylandとXorgで別々に保存されているので、Waylandセッションで必要なことはないはずです)。ログアウトして再ログインすると、これらの変更が完全に適用されます。

Xorg と Xorg ベースのデスクトップ環境は動作するはずですが、いくつかの既知の問題があります。
- 画面のテアリングが発生する (これは[すぐに](https://gitlab.freedesktop.org/xorg/xserver/-/merge_requests/1006)修正されるかも)
- VSyncが動作しない (一部のKDEアニメーションは速すぎ、GLアプリはVSyncを有効にしてもFPSが制限されない)。これは Apple DCP ディスプレイコントローラ上の Xorg の制限で、VBlank 割り込みをサポートしていません。
- Xorg/KWinによって引き起こされるドライバのバグがまだあります。これについては調査中です。

``linux-asahi-edge`` カーネルは標準の ``linux-asahi`` パッケージと一緒にインストールできますが、両方のバージョンは
同期している必要がありますので、常に一緒にパッケージを更新するようにしてください! GRUB ブートメニューで ``linux-asahi`` カーネルを選択すると、
GPU アクセラレーションと DCP ディスプレイドライバが無効になります。

今後パッケージが更新された場合、更新後に再起動するまでグラフィックアプリが起動しなくなったり、ソフトウェアレンダリングに
フォールバックする可能性があります。これは正常な状態です。UAPI が安定するまでは、Mesa とカーネル間の互換性を
時々破壊しなければならないので、アップデート後に動作させるためには再起動が必要になります。一般に、特定の Mesa 
アップデート後にアプリがアクセラレーションで動作し続ける場合は、おそらく再起動しなくても安全ですが、最新の
カーネルを実行していることを確認するために再起動する必要があります!

## バグの報告

ドライバはまだ開発中のため、多くの既知の問題があり、コンフォーマンステストの結果を改善するために懸命に取り組んでいます。アプリが動かないからといって、新しいバグを作らないでください。まだ開発初期であり、やるべきことがたくさんあることは分かっています。ここでは、バグを報告する方法について簡単に説明します。

- 全く起動しないアプリを見つけた場合、バグとして報告しないでください。多くのアプリは、私たちがサポートしているものよりも新しいGLバージョンを必要とするため、動作しません。これらのアプリがソフトウェアレンダリングにフォールバックするように、``LIBGL_ALWAYS_SOFTWARE=1`` 環境変数をセットしてください。もしそれが Arch Linux ARM リポジトリに含まれる人気のあるアプリであれば、代わりに[この issue](https://github.com/AsahiLinux/linux/issues/73) にコメントを書いてください、そうすれば私たちは回避策として Mesa quirks を追加することができます。
- GPU とは関係なく ``linux-asahi-edge`` によって引き起こされる問題に遭遇した場合は、[この issue](https://github.com/AsahiLinux/linux/issues/70) にコメントを追加してください。これにはディスプレイ出力の問題も含まれます! (解像度、バックライト制御、ディスプレイの電力制御など)
- GPUがロックアップし、すべてのGPUアプリが動作しなくなった場合、``asahi-diagnose``を実行し（例えば、SSHセッションから）、[AsahiLinux/linux](https://github.com/AsahiLinux/linux)に新しいバグを開き、そのコマンドで生成したファイルを添付し、ロックアップの原因となった行為を私たちに教えてください。
- その他のGPUの問題（レンダリングの不具合、正常に起動したアプリがクラッシュする、など）については、``asahi-diagnose``を実行し、[この問題](https://github.com/AsahiLinux/linux/issues/72)についてコメントを書き、そのコマンドによって生成されたファイルを添付してください。その際、お客様の環境についてお聞かせください。
- 将来的には、ドライバの更新がリグレッション (以前は正常に動作していたアプリケーションのレンダリング問題やクラッシュ) を引き起こした場合、[Mesa トラッカー](https://gitlab.freedesktop.org/asahi/mesa/-/issues)で直接バグを開くことができます。

私たちのドライバを楽しんでいただけると幸いです。このため、定期的にパッケージをアップデートして、アップデートとバグフィックスを取得するようにしてください。

#### Alyssa Rosenzweig & Asahi Lina · 2022-12-07

